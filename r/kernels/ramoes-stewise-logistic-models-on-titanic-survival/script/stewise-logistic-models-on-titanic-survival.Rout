
R version 3.6.1 (2019-07-05) -- "Action of the Toes"
Copyright (C) 2019 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin15.6.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> ## ---- message = FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> # Load packages
> library('ggplot2') # visualization
Warning message:
package ‘ggplot2’ was built under R version 3.6.2 
> library('ggthemes') # visualization
> library('scales') # visualization
Warning message:
package ‘scales’ was built under R version 3.6.2 
> library('dplyr') # data manipulation

Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Warning message:
package ‘dplyr’ was built under R version 3.6.2 
> library('mice') # imputation

Attaching package: ‘mice’

The following objects are masked from ‘package:base’:

    cbind, rbind

Warning message:
package ‘mice’ was built under R version 3.6.2 
> library('randomForest') # classification algorithm
randomForest 4.6-14
Type rfNews() to see new features/changes/bug fixes.

Attaching package: ‘randomForest’

The following object is masked from ‘package:dplyr’:

    combine

The following object is masked from ‘package:ggplot2’:

    margin

> 
> 
> ## ---- message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> train <- read.csv('../input/train.csv', stringsAsFactors = F)
> test  <- read.csv('../input/test.csv', stringsAsFactors = F)
> 
> full  <- bind_rows(train, test) # bind training & test data
> 
> # check data
> str(full)
'data.frame':	1309 obs. of  12 variables:
 $ PassengerId: int  1 2 3 4 5 6 7 8 9 10 ...
 $ Survived   : int  0 1 1 1 0 0 0 0 1 1 ...
 $ Pclass     : int  3 1 3 1 3 3 1 3 3 2 ...
 $ Name       : chr  "Braund, Mr. Owen Harris" "Cumings, Mrs. John Bradley (Florence Briggs Thayer)" "Heikkinen, Miss. Laina" "Futrelle, Mrs. Jacques Heath (Lily May Peel)" ...
 $ Sex        : chr  "male" "female" "female" "female" ...
 $ Age        : num  22 38 26 35 35 NA 54 2 27 14 ...
 $ SibSp      : int  1 1 0 1 0 0 0 3 0 1 ...
 $ Parch      : int  0 0 0 0 0 0 0 1 2 0 ...
 $ Ticket     : chr  "A/5 21171" "PC 17599" "STON/O2. 3101282" "113803" ...
 $ Fare       : num  7.25 71.28 7.92 53.1 8.05 ...
 $ Cabin      : chr  "" "C85" "" "C123" ...
 $ Embarked   : chr  "S" "C" "S" "S" ...
> 
> 
> ## ---- message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> # Grab title from passenger names
> full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)
> 
> # Show title counts by sex
> table(full$Sex, full$Title)
        
         Capt Col Don Dona  Dr Jonkheer Lady Major Master Miss Mlle Mme  Mr Mrs
  female    0   0   0    1   1        0    1     0      0  260    2   1   0 197
  male      1   4   1    0   7        1    0     2     61    0    0   0 757   0
        
          Ms Rev Sir the Countess
  female   2   0   0            1
  male     0   8   1            0
> 
> # Titles with very low cell counts to be combined to "rare" level
> rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
+                 'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
> 
> # Also reassign mlle, ms, and mme accordingly
> full$Title[full$Title == 'Mlle']        <- 'Miss' 
> full$Title[full$Title == 'Ms']          <- 'Miss'
> full$Title[full$Title == 'Mme']         <- 'Mrs' 
> full$Title[full$Title %in% rare_title]  <- 'Rare Title'
> 
> # Show title counts by sex again
> table(full$Sex, full$Title)
        
         Master Miss  Mr Mrs Rare Title
  female      0  264   0 198          4
  male       61    0 757   0         25
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> # Create a family size variable including the passenger themselves
> full$Fsize <- full$SibSp + full$Parch + 1
> 
> 
> ## ---- message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> # Use ggplot2 to visualize the relationship between family size & survival
> ggplot(full[1:891,], aes(x = Fsize, fill = factor(Survived))) +
+   geom_bar(stat='count', position='dodge') +
+   scale_x_continuous(breaks=c(1:11)) +
+   labs(x = 'Family Size') +
+   theme_few()
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> # Discretize family size
> full$FsizeD[full$Fsize == 1] <- 'singleton'
> full$FsizeD[full$Fsize < 5 & full$Fsize > 1] <- 'small'
> full$FsizeD[full$Fsize > 4] <- 'large'
> 
> # Show family size by survival using a mosaic plot
> mosaicplot(table(full$FsizeD, full$Survived), main='Family Size by Survival', shade=TRUE)
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> table(full$Survived)

  0   1 
549 342 
> prop.surv <- sum(train$Survived==1)/dim(train)[1]
> prop.surv
[1] 0.3838384
> #38.4% survived
> odds.surv <- prop.surv/(1-prop.surv)
> odds.surv
[1] 0.6229508
> logit.surv <- log(odds.surv)
> logit.surv
[1] -0.4732877
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> #Intercept only model
> #As we saw earlier, 0=not survived, 1=survived
> 
> null.glm <- glm(Survived ~ 1, family=binomial, data=full)
> summary(null.glm)

Call:
glm(formula = Survived ~ 1, family = binomial, data = full)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-0.9841  -0.9841  -0.9841   1.3839   1.3839  

Coefficients:
            Estimate Std. Error z value Pr(>|z|)    
(Intercept) -0.47329    0.06889   -6.87  6.4e-12 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1186.7  on 890  degrees of freedom
Residual deviance: 1186.7  on 890  degrees of freedom
  (418 observations deleted due to missingness)
AIC: 1188.7

Number of Fisher Scoring iterations: 4

> #Intercept==log odds=-.47, p<.001. AIC=1188.7, deviance=1186.7, df=890)
> #The probability of survival are obviously lower than the chances of not-surviving
> 
> #H0: odds(survival) = 1
> #H0: P(survival) = 0.5
> 
> b0 <- coef(null.glm)
> exp(b0) #odds of survival
(Intercept) 
  0.6229508 
> exp(b0)/(1+exp(b0)) #probability of survival
(Intercept) 
  0.3838384 
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> library(plyr)
------------------------------------------------------------------------------
You have loaded plyr after dplyr - this is likely to cause problems.
If you need functions from both plyr and dplyr, please load plyr first, then dplyr:
library(plyr); library(dplyr)
------------------------------------------------------------------------------

Attaching package: ‘plyr’

The following objects are masked from ‘package:dplyr’:

    arrange, count, desc, failwith, id, mutate, rename, summarise,
    summarize

> full$male <- revalue(full$Sex, c("male"="1", "female"="0"))
> 
> full$male <- as.numeric(full$male)
> library(Hmisc)
Loading required package: lattice
Loading required package: survival
Loading required package: Formula

Attaching package: ‘Hmisc’

The following objects are masked from ‘package:plyr’:

    is.discrete, summarize

The following objects are masked from ‘package:dplyr’:

    src, summarize

The following objects are masked from ‘package:base’:

    format.pval, units

Warning message:
package ‘survival’ was built under R version 3.6.2 
> describe(full)
full 

 16  Variables      1309  Observations
--------------------------------------------------------------------------------
PassengerId 
       n  missing distinct     Info     Mean      Gmd      .05      .10 
    1309        0     1309        1      655    436.7     66.4    131.8 
     .25      .50      .75      .90      .95 
   328.0    655.0    982.0   1178.2   1243.6 

lowest :    1    2    3    4    5, highest: 1305 1306 1307 1308 1309
--------------------------------------------------------------------------------
Survived 
       n  missing distinct     Info      Sum     Mean      Gmd 
     891      418        2     0.71      342   0.3838   0.4735 

--------------------------------------------------------------------------------
Pclass 
       n  missing distinct     Info     Mean      Gmd 
    1309        0        3    0.817    2.295   0.8689 
                            
Value          1     2     3
Frequency    323   277   709
Proportion 0.247 0.212 0.542
--------------------------------------------------------------------------------
Name 
       n  missing distinct 
    1309        0     1307 

lowest : Abbing, Mr. Anthony              Abbott, Master. Eugene Joseph    Abbott, Mr. Rossmore Edward      Abbott, Mrs. Stanton (Rosa Hunt) Abelseth, Miss. Karen Marie     
highest: Zabour, Miss. Hileni             Zabour, Miss. Thamine            Zakarian, Mr. Mapriededer        Zakarian, Mr. Ortin              Zimmerman, Mr. Leo              
--------------------------------------------------------------------------------
Sex 
       n  missing distinct 
    1309        0        2 
                        
Value      female   male
Frequency     466    843
Proportion  0.356  0.644
--------------------------------------------------------------------------------
Age 
       n  missing distinct     Info     Mean      Gmd      .05      .10 
    1046      263       98    0.999    29.88    16.06        5       14 
     .25      .50      .75      .90      .95 
      21       28       39       50       57 

lowest :  0.17  0.33  0.42  0.67  0.75, highest: 70.50 71.00 74.00 76.00 80.00
--------------------------------------------------------------------------------
SibSp 
       n  missing distinct     Info     Mean      Gmd 
    1309        0        7     0.67   0.4989    0.777 

lowest : 0 1 2 3 4, highest: 2 3 4 5 8
                                                    
Value          0     1     2     3     4     5     8
Frequency    891   319    42    20    22     6     9
Proportion 0.681 0.244 0.032 0.015 0.017 0.005 0.007
--------------------------------------------------------------------------------
Parch 
       n  missing distinct     Info     Mean      Gmd 
    1309        0        8    0.549    0.385   0.6375 

lowest : 0 1 2 3 4, highest: 3 4 5 6 9
                                                          
Value          0     1     2     3     4     5     6     9
Frequency   1002   170   113     8     6     6     2     2
Proportion 0.765 0.130 0.086 0.006 0.005 0.005 0.002 0.002
--------------------------------------------------------------------------------
Ticket 
       n  missing distinct 
    1309        0      929 

lowest : 110152      110413      110465      110469      110489     
highest: W./C. 6608  W./C. 6609  W.E.P. 5734 W/C 14208   WE/P 5735  
--------------------------------------------------------------------------------
Fare 
       n  missing distinct     Info     Mean      Gmd      .05      .10 
    1308        1      281        1     33.3    38.61    7.225    7.568 
     .25      .50      .75      .90      .95 
   7.896   14.454   31.275   78.051  133.650 

lowest :   0.0000   3.1708   4.0125   5.0000   6.2375
highest: 227.5250 247.5208 262.3750 263.0000 512.3292
--------------------------------------------------------------------------------
Cabin 
       n  missing distinct 
     295     1014      186 

lowest : A10 A11 A14 A16 A18, highest: F33 F38 F4  G6  T  
--------------------------------------------------------------------------------
Embarked 
       n  missing distinct 
    1307        2        3 
                            
Value          C     Q     S
Frequency    270   123   914
Proportion 0.207 0.094 0.699
--------------------------------------------------------------------------------
Title 
       n  missing distinct 
    1309        0        5 

lowest : Master     Miss       Mr         Mrs        Rare Title
highest: Master     Miss       Mr         Mrs        Rare Title
                                                                 
Value          Master       Miss         Mr        Mrs Rare Title
Frequency          61        264        757        198         29
Proportion      0.047      0.202      0.578      0.151      0.022
--------------------------------------------------------------------------------
Fsize 
       n  missing distinct     Info     Mean      Gmd 
    1309        0        9    0.773    1.884    1.328 

lowest :  1  2  3  4  5, highest:  5  6  7  8 11
                                                                
Value          1     2     3     4     5     6     7     8    11
Frequency    790   235   159    43    22    25    16     8    11
Proportion 0.604 0.180 0.121 0.033 0.017 0.019 0.012 0.006 0.008
--------------------------------------------------------------------------------
FsizeD 
       n  missing distinct 
    1309        0        3 
                                        
Value          large singleton     small
Frequency         82       790       437
Proportion     0.063     0.604     0.334
--------------------------------------------------------------------------------
male 
       n  missing distinct     Info      Sum     Mean      Gmd 
    1309        0        2    0.688      843    0.644   0.4589 

--------------------------------------------------------------------------------
> summary(full)
  PassengerId      Survived          Pclass          Name          
 Min.   :   1   Min.   :0.0000   Min.   :1.000   Length:1309       
 1st Qu.: 328   1st Qu.:0.0000   1st Qu.:2.000   Class :character  
 Median : 655   Median :0.0000   Median :3.000   Mode  :character  
 Mean   : 655   Mean   :0.3838   Mean   :2.295                     
 3rd Qu.: 982   3rd Qu.:1.0000   3rd Qu.:3.000                     
 Max.   :1309   Max.   :1.0000   Max.   :3.000                     
                NA's   :418                                        
     Sex                 Age            SibSp            Parch      
 Length:1309        Min.   : 0.17   Min.   :0.0000   Min.   :0.000  
 Class :character   1st Qu.:21.00   1st Qu.:0.0000   1st Qu.:0.000  
 Mode  :character   Median :28.00   Median :0.0000   Median :0.000  
                    Mean   :29.88   Mean   :0.4989   Mean   :0.385  
                    3rd Qu.:39.00   3rd Qu.:1.0000   3rd Qu.:0.000  
                    Max.   :80.00   Max.   :8.0000   Max.   :9.000  
                    NA's   :263                                     
    Ticket               Fare            Cabin             Embarked        
 Length:1309        Min.   :  0.000   Length:1309        Length:1309       
 Class :character   1st Qu.:  7.896   Class :character   Class :character  
 Mode  :character   Median : 14.454   Mode  :character   Mode  :character  
                    Mean   : 33.295                                        
                    3rd Qu.: 31.275                                        
                    Max.   :512.329                                        
                    NA's   :1                                              
    Title               Fsize           FsizeD               male      
 Length:1309        Min.   : 1.000   Length:1309        Min.   :0.000  
 Class :character   1st Qu.: 1.000   Class :character   1st Qu.:0.000  
 Mode  :character   Median : 1.000   Mode  :character   Median :1.000  
                    Mean   : 1.884                      Mean   :0.644  
                    3rd Qu.: 2.000                      3rd Qu.:1.000  
                    Max.   :11.000                      Max.   :1.000  
                                                                       
> class(full$male)
[1] "numeric"
> male.glm <- update(null.glm, ~ . + full$male)
> male.glm #AIC=921.8, LP=-2.51. Males are less likely to survive

Call:  glm(formula = Survived ~ full$male, family = binomial, data = full)

Coefficients:
(Intercept)    full$male  
      1.057       -2.514  

Degrees of Freedom: 890 Total (i.e. Null);  889 Residual
  (418 observations deleted due to missingness)
Null Deviance:	    1187 
Residual Deviance: 917.8 	AIC: 921.8
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> full$FsizeC <- revalue(full$FsizeD, c("singleton"="1", "small"="2", "large"="3"))
> full$FsizeCat <- as.numeric(full$FsizeC)
> fam.size.glm <- update(null.glm, ~. + full$FsizeCat)
> fam.size.glm

Call:  glm(formula = Survived ~ full$FsizeCat, family = binomial, data = full)

Coefficients:
  (Intercept)  full$FsizeCat  
      -0.9971         0.3538  

Degrees of Freedom: 890 Total (i.e. Null);  889 Residual
  (418 observations deleted due to missingness)
Null Deviance:	    1187 
Residual Deviance: 1176 	AIC: 1180
> 
> #Odds ratios of survival of singletons
> odds.single <- exp(coef(fam.size.glm)[1])
> odds.single
(Intercept) 
  0.3689531 
> #Odds ratio of survival of small families
> OR.fam <- exp(coef(fam.size.glm)[2])
> OR.fam
full$FsizeCat 
     1.424428 
> odds.small <- odds.single*OR.fam
> odds.large <- odds.single*OR.fam^2
> 
> #Probabilities of survival
> prob.single <- odds.single/(1+odds.single)
> prob.small <- odds.small/(1+odds.small)
> prob.large <- odds.large/(1+odds.large)
> c(prob.single, prob.small, prob.large)
(Intercept) (Intercept) (Intercept) 
  0.2695148   0.3444975   0.4281153 
> #Individuals with large families on the boat have highest probability of survival. This is probably because
> #richer people could bring along more family embers and had better access to rescue boats.
> #Singletons are most likely the poorer ones, able to only pay for one ticket, and worst access to rescue boats.
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> #Stepwise model selection
> log.model <- glm(Survived ~ FsizeCat*male*Age*SibSp*Fare, data=na.omit(full))
> final.model<-step(log.model, direction="backward", trace=FALSE)
> final.model

Call:  glm(formula = Survived ~ FsizeCat + male + Age + SibSp + Fare + 
    FsizeCat:male + FsizeCat:Age + male:Age + FsizeCat:SibSp + 
    male:SibSp + Age:SibSp + FsizeCat:Fare + male:Fare + Age:Fare + 
    SibSp:Fare + FsizeCat:male:Age + FsizeCat:male:SibSp + FsizeCat:Age:SibSp + 
    FsizeCat:male:Fare + FsizeCat:Age:Fare + FsizeCat:SibSp:Fare + 
    male:SibSp:Fare + Age:SibSp:Fare + FsizeCat:male:SibSp:Fare + 
    FsizeCat:Age:SibSp:Fare, data = na.omit(full))

Coefficients:
             (Intercept)                  FsizeCat                      male  
               0.4747852                 0.1881312                -1.1648638  
                     Age                     SibSp                      Fare  
               0.0146746                 0.7887922                 0.0067437  
           FsizeCat:male              FsizeCat:Age                  male:Age  
               0.6131417                -0.0115965                 0.0078582  
          FsizeCat:SibSp                male:SibSp                 Age:SibSp  
              -0.3723905                -0.4023464                -0.0246559  
           FsizeCat:Fare                 male:Fare                  Age:Fare  
              -0.0036242                 0.0029009                -0.0001887  
              SibSp:Fare         FsizeCat:male:Age       FsizeCat:male:SibSp  
              -0.0113149                -0.0101960                 0.0946975  
      FsizeCat:Age:SibSp        FsizeCat:male:Fare         FsizeCat:Age:Fare  
               0.0120113                -0.0020130                 0.0001357  
     FsizeCat:SibSp:Fare           male:SibSp:Fare            Age:SibSp:Fare  
               0.0047991                 0.0066497                 0.0005035  
FsizeCat:male:SibSp:Fare   FsizeCat:Age:SibSp:Fare  
              -0.0022197                -0.0002057  

Degrees of Freedom: 713 Total (i.e. Null);  688 Residual
Null Deviance:	    172.2 
Residual Deviance: 100.4 	AIC: 679.9
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> Prediction <- (1- full$male)
> train <- full[1:891,]
> test <- full[892:1309,]
> if (full$PassengerId>=892) {
+  prediction <- (1- full$male)
+  }
Warning message:
In if (full$PassengerId >= 892) { :
  the condition has length > 1 and only the first element will be used
> newdata <- subset(test, PassengerId>=892, 
+     select=c(PassengerId, Prediction)) 
> solution <- data.frame(PassengerID = full$PassengerId, Survived = Prediction)
> write.csv(solution, file = 'glmsolution.csv', row.names = F)
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> 
> # Write the solution to file
> #train1 <- full[1:891,]
> #test1 <- full[892:1309,]
> #lm.model <- lm(Survived ~ FsizeCat+male+Age+SibSp+Fare, test1)
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> #prediction <- predict(lm.model, test)
> 
> 
> ## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
> #solution <- data.frame(PassengerID = test$PassengerId, Survived = prediction)
> #write.csv(solution, file = 'rf_mod_Solution.csv', row.names = F)
> 
> 
> proc.time()
   user  system elapsed 
  2.135   0.172   2.309 
