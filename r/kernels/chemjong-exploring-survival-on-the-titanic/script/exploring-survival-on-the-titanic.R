## ----setup, include=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)


## ----message=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

library(tidyverse)
library(VIM)
library(RColorBrewer)
library(viridis)
library(DT)
library(magrittr)
library(scales)
library(ggstance)
library(mice)
library(stringr)
library(mice)
library(party)
library(caret)
library(ROCR)
library(e1071)
library(randomForest)
library(adabag)
library(ggstance)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


raw_train <- read.csv('../input/train.csv', stringsAsFactors = F)
raw_test  <- read.csv('../input/test.csv', stringsAsFactors = F)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary (raw_train)

summary (raw_test)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
colnames_train <- names(raw_train)

colnames_test <- names(raw_test)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
setdiff (colnames_train, colnames_test)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
setdiff (colnames_test, colnames_train)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 <- bind_rows(raw_train, raw_test)

data1$Survived <- as.factor(data1$Survived)
data1$SibSp <- as.factor(data1$SibSp)
data1$Parch <- as.factor(data1$Parch)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 %>% 
        map_dbl(~sum(is.na(.)))

map_dbl(data1, ~sum((is.na(.) == T)/length(.))*100)


## ----message=F, results='hide'---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# aggr_col<- viridis (n = 4, alpha = 0.5,  begin = 0, end =1, option = "D" )

aggr_col <- c('lightseagreen', 'red')

aggr (data1, col = aggr_col, combined = T, sortVars = T, sortCombs = T, cex.axis = .8)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1$Title <- str_replace_all(data1$Name, '(.*, )|(\\..*)', "")

table(data1$Sex,data1$Title)


print("Unique Titles are: "); unique(data1$Title)




## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
replace_var <- c("Mme", "Ms", "Lady", "Mlle")

data1$Title <-  gsub("Mme|Ms|Lady|Mlle", "Miss", data1$Title)

data1$Title <- gsub("Capt|Col|Don|Dr|Jonkheer|Major|Master|Rev|Sir|the Countess", "Others", data1$Title )

data1$Title <-gsub("Othersa", "Others", data1$Title )





## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

data1 <- data1 %>% 
        mutate(Fam_size = as.numeric(SibSp) + as.numeric(Parch) + 1) %>% 
        mutate(Family = case_when(.$Fam_size == 1 ~ "Single", .$Fam_size >1 & .$Fam_size < 5 ~ "Mid Family", .$Fam_size >4 ~ "Large Family"))
        
table(data1$Family)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1$Cabin_initial <- str_sub(data1$Cabin, 1,1)

unique(data1$Cabin_initial)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
embarked_missing <- data1 %>% 
        filter(is.na(Embarked))

datatable(embarked_missing)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 %$% 
        unique(Cabin) %>% 
        summary()
        




## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 %$%
        unique(Ticket) %>% 
        summary()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

data1 %>% 
        filter(!is.na(Embarked)) %>% 
        ggplot(aes(x = as.factor(Pclass), y = Fare, fill = as.factor(Pclass)))+
        geom_boxplot()+
        facet_wrap(~as.factor(Embarked), scales = "free")+
        labs(x = "Pclass")+
        scale_y_continuous(labels = scales::dollar)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 %>% 
        filter(Pclass == 1, Embarked == "C") %>% 
        summarise(Pclass1_median = median(Fare, na.rm=T))
        


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1$Embarked[data1$PassengerId == 62 | data1$PassengerId == 830] <- "C"



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fare_na <- data1 %>% 
        filter(is.na(Fare))
datatable(fare_na)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1 %>% 
        filter(Pclass == 3, Embarked == "S") %>% 
        ggplot(aes(x = Fare, y = ..density..))+
        geom_density(show.legend = F, fill = "peachpuff3")+
        geom_vline(aes(xintercept = median(Fare, na.rm = T)),linetype = "dashed", lwd = 1, col = "red")+
        scale_x_continuous(labels = scales::dollar)+
        labs(title = "Density Plot - $Fares for Pclass = 3 & Embarked = 'S' ")


data1 %>% 
        filter(Pclass == 3, Embarked == "S") %>% 
        ggplot(aes(x = Pclass, y = Fare))+
        geom_boxplot()+
        labs(x = "Pclass 3", title = "Box Plot - $Fares for Pclass = 3 & Embarked = 'S' ")

median_fare_p3_S <- data1 %>% 
        filter(Pclass == 3, Embarked == "S") %$%
        median(Fare, na.rm=T)

paste0("The median fare for Pclas 3 & Embarked = 'S' is $", median_fare_p3_S)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data1$Fare[data1$PassengerId == 1044] <- median_fare_p3_S



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# names(data1)

var_factors <- c("PassengerId", "Pclass", "Sex", "Embarked", "Title", "Fam_size", "Family")

data1[var_factors] <- map_df(data1[var_factors], ~as.factor(.))





## ----results = "hide", message = F-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

set.seed(1)

names(data1)

data1$Age_org <- data1$Age

data1$Age_imp <- is.na(data1$Age)

mice_m1 <- data1 %>% 
        select(Pclass, SibSp, Parch, Fare, Embarked, Title, Fam_size, Age) %>% 
        mice(method = "rf")

mice_m1_output <- complete(mice_m1)

data1$Age <- mice_m1_output$Age

data1 %>% 
        ggplot(aes( x= Age_org, fill = Age_imp))+
        geom_histogram(col = "black", show.legend = F)+
        labs(title = "Histogram of Age")

data1 %>% 
        ggplot(aes(x = Age, fill = Age_imp))+
        geom_histogram(col = "black")+
        labs(title = "Histogram of Age with imputed value highlighted")





## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

train_edited <- data1[1:891,]
test_edited <- data1[892:1309, ]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
prop.table(table(train_edited$Survived, train_edited$Sex),2)





## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

pclass_Sex <- train_edited %>% 
        group_by(Survived, Pclass, Sex, Family, Title) %>% 
        summarise(n=n())

datatable(pclass_Sex, caption = "Survivor Table")

pclass_Sex %>% 
        ggplot(aes(x = Pclass, y = n))+
        geom_bar(aes(fill = Title), stat="identity")+
        facet_wrap(Survived~Sex, scales = "free_y")
        
pclass_Sex %>% 
        ggplot(aes(x = Pclass, y = n))+
        geom_bar(aes(fill = Family), stat="identity")+
        facet_wrap(Survived~Sex)




## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train_edited %>% 
        ggplot(aes(x = Fam_size, fill = Survived))+
        geom_bar(position = "dodge")+
        labs(x = "Family Size")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train_edited %>% 
        ggplot(aes(x = Age, y = Survived, fill = Sex))+
        geom_boxploth()+
        geom_jitter(alpha = 0.09)+
        labs(x = "Age")
        


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
datatable(train_edited %>% 
        group_by(Survived, Sex) %>% 
        summarise(average_age = median(Age),Count=n()))
        


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
split.data <- function(data, p = .7, s=007) {
        set.seed(s)
        n <- nrow(data)
        train_index <- sample(1:n, size= round(p*n)) 
        trainset <- data[train_index, ]
        testset <- data[-train_index, ]
        list(trainset = trainset, testset=testset)
}



allset <- split.data(train_edited)


trainset <- allset$trainset
testset <- allset$testset






## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
trainset.ctree <- ctree(Survived ~ Pclass + Sex + SibSp + Parch + Fare + Embarked + Title + Fam_size + Age + Family, trainset)


## ----fig.width = 8, fig.height = 5-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(trainset.ctree)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ctree_predict <- predict(trainset.ctree, testset)

conf_matrix_ctree<- confusionMatrix(ctree_predict, testset$Survived)

conf_matrix_ctree

accurary_ctree <- 8.239700e-01 *100

paste0("The the confusion matrix overall accurary is ", accurary_ctree, "% when using Conditional inference tree")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
trainset.rf <- randomForest(Survived ~ Pclass + Sex + SibSp + Parch + Fare + Embarked + Title + Fam_size + Age + Family, data=trainset, importance = T)

rf_predict <- predict(trainset.rf, trainset)

conf_rf <- confusionMatrix(rf_predict, trainset$Survived)

conf_rf


rf_accuracy <- 9.310897e-01*100
 
paste0("The the confusion matrix overall accurary is ", rf_accuracy, "% when using randomForest")




## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(trainset.rf, main = "Mean square error rate")
legend('topright', legend = colnames(trainset.rf$err.rate), col=1:3, fill=1:3)




## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

datatable(importance(trainset.rf), caption = "Relative Variable Importance")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
varImpPlot(trainset.rf, main = "Plot of relative variable importance as measured by randomForest")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# predictions <- predict(trainset.rf, test_edited)
# 
# solution <- data.frame(PassengerID = test_edited$PassengerId, Survived = predictions)
# 
# write.csv(solution, file = "Titanic_Survival_pred_rf.csv", row.names = F)

## 0.77990 kaggle score


