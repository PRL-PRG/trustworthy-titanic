---
title: "Kaggle Titanic competition"
author: "Morris Stallmann"
date: "19 Septembre 2016"
output: html_document
---
My approach to the Titanic competion on Kaggle is highly influenced by the great statsguys' tutorial (https://statsguys.wordpress.com/2014/01/03/first-post/) and the beautiful tutorial by Megan Risdal (https://www.kaggle.com/mrisdal/titanic/exploring-survival-on-the-titanic).


```{r}
library(ggplot2); library(caret); library(Hmisc)
```

## Getting started
We read in the training data and (sub-)split that dataset into a test- and training dataset. We'll only use the training data for building the predicition model, then test on the testing set if the model was any good. We can't use the provided testing set, because it doesn't contain information about whether a passenger survived.

```{r}
trainData <- read.csv("../input/train.csv", header = TRUE, stringsAsFactors = FALSE)
testData <- read.csv("../input/test.csv", header = TRUE, stringsAsFactors = FALSE)
inTrain <- createDataPartition(y=trainData$Survived, p=0.8, list=FALSE)
trainDataTest <- trainData[-inTrain,]
trainData <- trainData[inTrain,]
```

## Get an idea of the data

First of all, we want to get an idea of what we are dealing with.

```{r}
str(trainData)
summary(trainData$Age)
```

## Exploratory Analysis

Let's try to gain a deeper insight by using some basic plotting.

```{r pressure, echo=FALSE}
plot(density(trainData$Age, na.rm = TRUE), main="Age density")
```

### Survival by sex
One of the first thing that came to my mind was "Women and children first". Let's see if this a reasonable assumption.
```{r}
t1 <- table(trainData$Survived, trainData$Sex)
barplot(t1, xlab = "Gender", ylab = "Number of People", main = "survived and deceased between male and female")
prop.table(t1)
```

Note that the brighter area indicates "survived". Looks like the first assumption is reasonable.

### What about Age?

I would apriori expect, very young and very old passengers have a higher chance of survival. How is the survival rate for certain age ranges?

```{r}
cutAge <- cut2(trainData$Age, g=6)
tableAge <- table(trainData$Survived, cutAge)
prop.table(tableAge)
```

Very old people seem to have a slightly higher survival chance. 
Take a look at the many missing values:
```{r}
sum(trainData$Survived[is.na(trainData$Age)])/sum(is.na(trainData$Age))
```

Wow, that's a surprise (at least for me)! Passengers with missing age values had a survival chance of about 30%! (Although, it isn't useful for building a model- I've tried.)

### Survival by class

A passengers class supposingly correlates to a passenger's location on board and therefor for a passenger's survival rate. Let's check if that ide holds true.
```{r}
t2 <- table(trainData$Survived,trainData$Pclass)
t2/rep(apply(t2, 2, sum), each=2)
```
The table shows the survival rate in each class and it clearly shows the class correlates to a passenger's survival.

Note: Other variables, that might have something to do with a passenger's location on board: Cabin, Embarked, Fare.

##Cabin
It seems odd that so many people have no information about their cabin. Taking a closer look, you'll see that mostly people from lower classes have no information about their cabin. Let's see if it holds any valuable information:
```{r}
trainData$hasCabin <- "noCabin"
for(i in 1:length(trainData$Survived)){
  if(trainData$Cabin[i]!="") trainData$hasCabin[i] <- "hasCabin"
}
table(trainData$Survived, trainData$hasCabin)
```

Passenger with information about their cabin seem to have a higher survival rate.

```{r}
trainDataTest$hasCabin <- "noCabin"
for(i in 1:length(trainDataTest$Survived)){
  if(trainDataTest$Cabin[i]!="") trainDataTest$hasCabin[i] <- "hasCabin"
}

testData$hasCabin <- "noCabin"
for(i in 1:length(testData$PassengerId)){
  if(testData$Cabin[i]!="") testData$hasCabin[i] <- "hasCabin"
}
```

### Does a high fare correlate with a high survival rate?
```{r}
cutFare <- cut2(trainData$Fare, g=5)
t3 <- table(trainData$Survived, cutFare)
prop.table(t3)
barplot(t3, xlab="Fare", ylab="count", main="Survival by Fare")
median(trainData$Fare)
```
Looks like there's a trend.

## Create dummy variables
It's not necessary here (because of the model I choose), but it doesn't hurt either and sometimes I am a little superstitious.

###Sex
```{r}
trainData$Sex <- gsub("female", 1, trainData$Sex)
trainData$Sex <- gsub("^male", 0, trainData$Sex)
trainData$Sex <- as.numeric(trainData$Sex)
trainDataTest$Sex <- gsub("female", 1, trainDataTest$Sex)
trainDataTest$Sex <- gsub("^male", 0, trainDataTest$Sex)
trainDataTest$Sex <- as.numeric(trainDataTest$Sex)
testData$Sex <- gsub("female", 1, testData$Sex)
testData$Sex <- gsub("^male", 0, testData$Sex)
testData$Sex <- as.numeric(testData$Sex)
```

###Embarked
```{r}
places <- c("S", "C", "Q")
trainData$Embarked <- match(trainData$Embarked, places)
trainDataTest$Embarked <- match(trainDataTest$Embarked, places)
testData$Embarked <- match(testData$Embarked, places)
```

##Create new variables

###Creating Title variable
The Name variable itself isn't really useful, but we can create a Title variable from it. Why could that be helpful? It might be a shot in the dark, but maybe a person's Title is an indicator for their reputation. Assuming passengers with higher reputation are more likely to be saved, this might be a good predictor. (I think this idea is brillant, but I stole it from Meg. :)
```{r}
summary(trainData$Name)
createTitles <- function(names){
  namesSplit <- strsplit(names, " ")
  commonTitles <- c("Col.", "Dr.", "Major", "Master", "Miss.", "Mr.", "Mrs.", "Rev.")
  titles <- ""
  for(i in 1:length(namesSplit)){
    if(is.na(match(namesSplit[[i]][2], commonTitles))){
      titles <- c(titles,"UT")
    }
       else{
    titles <- c(titles, namesSplit[[i]][2])
       }
  }
  return(as.factor(titles[-1]))
}
Titles <- createTitles(trainData$Name)
summary(Titles)
```

Well, it's not 100%, but should be allright for now. So, we add the variable to our set:

```{r}
trainData$Title <- Titles
trainDataTest$Title <- createTitles(trainDataTest$Name)
testData$Title <- createTitles(testData$Name)
```

###Family
Supposingly family size has an impact on survival. So, we create a family variable, which is simply "SibSp+Parch"
```{r}
trainData$Family <- trainData$SibSp+trainData$Parch
trainDataTest$Family <- trainDataTest$SibSp+trainDataTest$Parch
testData$Family <- testData$SibSp+testData$Parch
```

##Missing values

###Interfer missing age values

We will replace a missing age value with that person's Title-group-age-mean.

```{r}
#note that the fuction returns the full ages vector containing the infered values
ageInference <- function(allAges, allTitles){
  for (i in 1:length(allAges)){
    if(is.na(allAges[i])){
      tmpTitle <- allTitles[i]
      allAges[i] <- round(mean(allAges[allTitles == tmpTitle], na.rm=TRUE), digits=2)
    }
  }
  #if there are still missing values, just replace them by the overall mean:
  for(i in 1:length(allAges)){
    if(is.na(allAges[i])) allAges[i] <- round(mean(allAges, na.rm=TRUE), digits=2)
  }
  return(allAges)
}
ageInf <- ageInference(trainData$Age, trainData$Title)
summary(ageInf)
summary(trainData$Age)
trainData$AgeInf <- ageInf
ggplot()+
  geom_density(data=trainData, aes(x=Age), color="red")+
  geom_density(data=trainData, aes(x=AgeInf), color="green")

trainDataTest$AgeInf <- ageInference(trainDataTest$Age, trainDataTest$Title)
testData$AgeInf <- ageInference(testData$Age, testData$Title)
```

Well. Could be worse.

###Any more missing values?

```{r}
summary(trainData)
summary(trainDataTest)
summary(testData)
plot(as.factor(trainData$Embarked))

#replace missing Embarked by 1

trainData$Embarked[is.na(trainData$Embarked)] <- 1
trainDataTest$Embarked[is.na(trainDataTest$Embarked)] <- 1
testData$Embarked[is.na(testData$Embarked)] <- 1

#replace missing Fare by overall mean
trainData$Fare[is.na(trainData$Fare)] <- round(mean(trainData$Fare, na.rm=TRUE), digits=2)
trainDataTest$Fare[is.na(trainDataTest$Fare)] <- round(mean(trainDataTest$Fare, na.rm=TRUE), digits=2)
testData$Fare[is.na(testData$Fare)] <- round(mean(testData$Fare, na.rm=TRUE), digits=2)
```

##Train the model
We build a with random forest and cross validation. Note, that we do not include all variables for building our model.
```{r}
trainData$Survived <- as.factor(trainData$Survived)
trainDataTest$Survived <- as.factor(trainDataTest$Survived)

control <- trainControl(method="cv", number=5)
mod1 <- train(trainData$Survived ~ Pclass + Sex + AgeInf + SibSp + Parch + Fare + Embarked + Title + Family + hasCabin, data=trainData, method="rf", trControl=control)
```

##Evaluate the model

###Variable importance
```{r}
plot(varImp(mod1))
```

##Error
```{r}
pred1 <- predict(mod1, newdata=trainDataTest)
confMat <- confusionMatrix(pred1, trainDataTest$Survived)
confMat$overall
confMat$table
```
We have an accuracy of about 80%!