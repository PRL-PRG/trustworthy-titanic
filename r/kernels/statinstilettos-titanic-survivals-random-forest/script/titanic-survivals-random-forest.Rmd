---
title: "Titanic Random Forest"
author: "Claire Longo"
output: html_document
---

This is my first Kaggle kernel. I am using a Random Forest in R to classify survival of passangers on the Titanic.

```{r, message = FALSE, echo = FALSE, message=FALSE, warning=FALSE}
library(randomForest)
library(knitr)
library(reshape2)
library(ggplot2)
set.seed(1)

# read in the data
train <- read.csv("../input/train.csv")
test  <- read.csv("../input/test.csv")

#converty type of variable to factor when approriate
train$Survived <- as.factor(train$Survived)
train$Pclass <- as.factor(train$Pclass)
test$Pclass <- as.factor(test$Pclass)

levels(test$Embarked) <- levels(train$Embarked)

#just impute NAs with median
#test$Age[is.na(test$Age)] = median(test$Age, na.rm=TRUE)
#test$Fare[is.na(test$Fare)]=median(test$Fare, na.rm=TRUE)
#train$Age[is.na(test$Age)] = median(train$Age, na.rm=TRUE)
#train$Fare[is.na(test$Fare)]=median(train$Fare, na.rm=TRUE)

# Grab title from passenger names
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
                
train$Title <-  as.factor(gsub('(.*, )|(\\..*)', '', train$Name))
train$Title[train$Title == 'Mlle']        <- 'Miss' 
train$Title[train$Title == 'Ms']          <- 'Miss'
train$Title[train$Title == 'Mme']         <- 'Mrs' 
train$Title[train$Title %in% rare_title]  <- 'Rare Title'

test$Title <-  as.factor(gsub('(.*, )|(\\..*)', '', test$Name))
test$Title[test$Title == 'Mlle']        <- 'Miss' 
test$Title[test$Title == 'Ms']          <- 'Miss'
test$Title[test$Title == 'Mme']         <- 'Mrs' 
test$Title[test$Title %in% rare_title]  <- 'Rare Title'
levels(test$Title) <- levels(train$Title)

# Create a family size variable 
train$Fsize <- train$SibSp + train$Parch + 1
test$Fsize <- test$SibSp + test$Parch + 1

#create child variable
train$Child[train$Age < 18] <- 'Child'
train$Child[train$Age >= 18] <- 'Adult'
train$Child <-  as.factor(train$Child)
test$Child[test$Age < 18] <- 'Child'
test$Child[test$Age >= 18] <- 'Adult'
test$Child <-  as.factor(test$Child)

# create mother variable
train$Mother <- 'Not Mother'
train$Mother[train$Sex == 'female' & train$Parch > 0 & train$Age > 18 & train$Title != 'Miss'] <- 'Mother'
train$Mother <-  as.factor(train$Mother)
test$Mother <- 'Not Mother'
test$Mother[test$Sex == 'female' & test$Parch > 0 & test$Age > 18 & test$Title != 'Miss'] <- 'Mother'
test$Mother <-  as.factor(test$Mother)

```

# Exploratory Analysis

There is an unequal sample size for the two survival categories. Stratified sampling will be used. 

```{r, message = FALSE, echo = TRUE}
barplot(table(train$Survived), main="Sample size by Survived", xlab="Survival", ylab="Count")
```

There is an outlier in the Fare variable. This observation is removed. 

```{r, message = FALSE, echo = TRUE, warnings=FALSE}
#plot numeric variables
suppressWarnings(print(
ggplot(melt(subset(train, select=c("PassengerId",  "Age", "Fare")),id.vars=c('PassengerId')), aes(x=value,fill=variable)) +
        geom_histogram(colour="black") +
        facet_grid(.~variable, scales='free_x') +
        ggtitle("Distributions of continuous variables")
))

#remove ticket number associated with outlier Fare
train=train[train$Ticket!=unique(train[train$Fare==max(train$Fare),]$Ticket),]

#plot factor variables
suppressWarnings(print(
ggplot(melt(subset(train, select=c("PassengerId",  "Pclass", "Sex", "SibSp", "Parch", "Embarked")),id.vars=c('PassengerId')),
        aes(x=value,fill=variable)) +
        geom_bar(colour="black") +
        facet_grid(.~variable, scales='free_x') +
        ggtitle("Distributions of factor variables")
))

#converty type of variables to factor when approriate
train$Survived <- as.factor(train$Survived)
train$Pclass <- as.factor(train$Pclass)
  
```


# Random Forest Classification

I am using a random forest with stratified sampling to predict the survival of passangers on the Titanic.  The trees converge for both classes after about 120 trees.

```{r, message = FALSE, echo = TRUE}
mySampSize <- c(min(table(train$Survived)),min(table(train$Survived)))

rf <- randomForest(Survived~Title+Fsize+Child+Mother+Age+Fare+Pclass+Sex+SibSp+Parch+Embarked, 
                   data=train,
                   ntree=500,
                   mtry=7,
                   na.action=na.exclude)

# plot error convergence
plot(rf, main="OOB error rate and\nerror rate for each class across trees")
```

The confusion matrix shows how many observations were classified correctly and incorrectly for each class. 
The variable importance table is relative. The variables with the highest metric are the most important. 

```{r, message = FALSE, echo = TRUE}
# confusion matrix
rf$confusion

#variable importance
rf$importance #relative. high values indicate high importance
```

The porportion of predictions for each class appears reasonable when compared to the truth data. 

```{r, message = FALSE, echo = TRUE}
# plot training results
par(mfrow=c(1,2))
plot(rf$y, main="Histogram of true survival values", col="forestgreen")
plot(rf$predicted, main="Histogram of fit survivial values", col="yellow")

# Validation metrics
Accuracy.fit <- 1-rf$err.rate[nrow(rf$err.rate),1]
print(paste("The accuracy of this model is", round(Accuracy.fit,4), sep=" "))
```

```{r, message = FALSE, echo =TRUE}
#prediction
prediction <- data.frame(PassengerId=test$PassengerId, Survived=predict(rf, test))
write.csv(prediction, file = 'RF_prediction.csv', row.names = F)


```


