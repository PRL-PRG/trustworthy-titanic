---
title: 'gettingStarted_Titanic'
author: 'frareb'
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document
---

# 1. loading packages

```{r}
# nothing for now
```

# 2. reading data

```{r}
bddTrain <- read.table("../input/train.csv", header = TRUE, 
  sep = ",", stringsAsFactors = FALSE)
bddTest <- read.table("../input/test.csv", header = TRUE, 
  sep = ",", stringsAsFactors = FALSE)
str(bddTrain)
str(bddTest)
```

Modifying data types:

* PassengerId to character
* Survived to logical
* Pclass to factor
* Sex to factor
* Age to integer
* Embarked to factor

```{r}
# train
bddTrain$PassengerId <- as.character(bddTrain$PassengerId)
bddTrain$Survived <- as.logical(bddTrain$Survived)
bddTrain$Pclass <- as.factor(bddTrain$Pclass)
bddTrain$Sex <- as.factor(bddTrain$Sex)
bddTrain$Age <- as.integer(bddTrain$Age)
bddTrain$Embarked <- as.factor(bddTrain$Embarked)
str(bddTrain)

# test
bddTest$PassengerId <- as.character(bddTest$PassengerId)
bddTest$Pclass <- as.factor(bddTest$Pclass)
bddTest$Sex <- as.factor(bddTest$Sex)
bddTest$Age <- as.integer(bddTest$Age)
bddTest$Embarked <- as.factor(bddTest$Embarked)
str(bddTest)
```

Using NA when data are missing (e.g., Embarked should have 3 levels not 4):

```{r}
# train
bddTrain$Cabin[bddTrain$Cabin == ""] <- NA
tmp <- as.character(bddTrain$Embarked)
tmp[tmp == ""] <- NA
bddTrain$Embarked <- as.factor(tmp)
rm(tmp)

# test
bddTest$Cabin[bddTest$Cabin == ""] <- NA
tmp <- as.character(bddTest$Embarked)
tmp[tmp == ""] <- NA
bddTest$Embarked <- as.factor(tmp)
rm(tmp)
```

# 3. Studying variables with descriptive statistics

## 3.1. `PassengerId`

Nothing here, just ID ?

## 3.2. `Pclass`

```{r}
getVarBarplot <- function(myVar, doSort = TRUE){
  meanS <- tapply(bddTrain$Survived, INDEX = bddTrain[myVar], 
    FUN = mean, na.rm = TRUE)
  if(doSort == TRUE){
    nS <- table(bddTrain[myVar])[order(meanS, decreasing = TRUE)]
    meanS <- meanS[order(meanS, decreasing = TRUE)]
  } else {
    nS <- table(bddTrain[myVar])
  }
  bplot <- barplot(meanS, xlab = myVar, ylab = "Mean survival rate")
  text(x = bplot, y = meanS, labels = nS, pos = 1)
}
getVarBarplot(myVar = "Pclass")
```

Variable `Pclass` suggests that passengers with higher class have a higher probability of survival

## 3.3. `Name`

As suggested by Megan L. Risdal (https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic), we can extract the title from the names and use it as a variable.

```{r}
# this code is copied with small modifications from: 
# https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic
bddTrain$Title <- gsub('(.*, )|(\\..*)', '', bddTrain$Name)
bddTest$Title <- gsub('(.*, )|(\\..*)', '', bddTest$Name)
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
# train
bddTrain$Title[bddTrain$Title == 'Mlle']        <- 'Miss' 
bddTrain$Title[bddTrain$Title == 'Ms']          <- 'Miss'
bddTrain$Title[bddTrain$Title == 'Mme']         <- 'Mrs' 
bddTrain$Title[bddTrain$Title %in% rare_title]  <- 'Rare Title'
table(bddTrain$Title)

# test
bddTest$Title[bddTest$Title == 'Mlle']        <- 'Miss' 
bddTest$Title[bddTest$Title == 'Ms']          <- 'Miss'
bddTest$Title[bddTest$Title == 'Mme']         <- 'Mrs' 
bddTest$Title[bddTest$Title %in% rare_title]  <- 'Rare Title'
table(bddTest$Title)
```

Then we can plot titles against survival.

```{r}
getVarBarplot(myVar = "Title")
```

Variable `Title` suggests that "Mrs" and "Miss" have higher probability of survival.

## 3.4. `Sex`

```{r}
getVarBarplot(myVar = "Sex")
```

Variable `Sex` suggests that females have higher probability of survival.

## 3.5. `Age`

```{r}
getVarBarplot(myVar = "Age", doSort = FALSE)
```

Variable `Age` suggests that younger have a higher probability of survival (for older people the number of people is not enough to draw any conclusion).

## Number of siblings / parents (`SibSp` and `Parch`)

```{r}
bddTrain$Fsize <- bddTrain$SibSp + bddTrain$Parch
bddTest$Fsize <- bddTest$SibSp + bddTest$Parch
getVarBarplot(myVar = "Fsize", doSort = FALSE)
```

We can see that few families have more than 2 other members onboard (89.8% in [0:2)). The data suggest that up to 3 other members, there is an increasing probability of survival (and then a probable decreasing). 

## 3.6. `Ticket`

```{r}
cat(paste0("There are ", length(bddTrain$Ticket), " passengers and ", 
  length(unique(bddTrain$Ticket)), " tickets numbers."))
```

Some passengers have the same ticket number, probably because of compartments without specific number (or surbooking ;-)). Some have letters on it, while others just numbers. By identifying Ticket numbers, maybe there is something to do regarding where the passengers were seated, and compute a probability of survival based on the survival of people seated next to a passenger. I won't explore that for now.

## 3.7. `Fare`

```{r}
getVarBarplot(myVar = "Fare", doSort = FALSE)
```

It is hard to suggest anything because most passengers paid a different fare. A possibility is to regroup the data according to breaks.

```{r}
bddTrain$FareGp <- cut(bddTrain$Fare, c(0, 20, 50, 100, 300, 600))
bddTest$FareGp <- cut(bddTest$Fare, c(0, 20, 50, 100, 300, 600))
getVarBarplot(myVar = "FareGp", doSort = FALSE)
```

Variable `Fare` suggests that higher fare led to higher probability of survival.

## 3.8. `Cabin`

Variable `Cabin` start with a letter that may means something. Lots of passengers do not have a Cabin number but we do not know if this is because they do not have a cabin or because the information is missing (no apparent link with Ticket number using `bddTrain$Ticket[!is.na(bddTrain$CabLetter)]`).

```{r}
bddTrain$CabLetter <- substr(bddTrain$Cabin, start = 1, stop = 1)
bddTest$CabLetter <- substr(bddTest$Cabin, start = 1, stop = 1)
getVarBarplot(myVar = "CabLetter")
```

This is not clear if the letter associated with the cabin has an influence on survival.

```{r}
bplot <- barplot(c(mean(bddTrain$Survived[is.na(bddTrain$CabLetter)]), 
  mean(bddTrain$Survived[!is.na(bddTrain$CabLetter)])), names.arg = 
    c("NA", "Cabin"))
text(x = bplot, y = c(mean(bddTrain$Survived[is.na(bddTrain$CabLetter)]), 
  mean(bddTrain$Survived[!is.na(bddTrain$CabLetter)])), labels = 
  c(length(bddTrain$Survived[is.na(bddTrain$CabLetter)]), 
    length(bddTrain$Survived[!is.na(bddTrain$CabLetter)])), pos = 1)
```

Having a cabin number suggests a higher probability of survival.

```{r}
bddTrain$CabLetterTF <- !is.na(bddTrain$CabLetter)
bddTest$CabLetterTF <- !is.na(bddTest$CabLetter)
```

## 3.9. `Embarked`

```{r}
sum(is.na(bddTrain$Embarked))
getVarBarplot(myVar = "Embarked")
```

The variable `Embarked` suggests that passengers from "C" have a higher probability of survival over "Q" and "S", and those from "Q" over "S".

## 3.10. Conclusion

We have new variables for studying passenger survival, and ideas on what to explore.

```{r}
str(bddTrain)
```

# 4. Explaining survival


