## ----include=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(tidyverse) #Cleaning, visualization...
library(ggthemes) # visualisation
library(stringr)
library(scales)
library.path <- cat(.libPaths())
library("mice", lib.loc = library.path)
library(mice) # NA replacement
library(ranger)
library(caret)
library(randomForest) # forecast


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train <- read.csv('../input/train.csv', stringsAsFactors = F)
test  <- read.csv('../input/test.csv', stringsAsFactors = F)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
test.survived<-data.frame(Survived= rep("None", nrow(test)), test[,])
head(test.survived)
ntest.survived<-test.survived[,c(2,1,3,4,5,6,7,8,9,10,11,12)]
head(ntest.survived)
names(train)
names(ntest.survived)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined<-rbind(train,ntest.survived)
glimpse(data.combined)

data.combined$Survived<-as.factor(data.combined$Survived)
data.combined$Pclass<-as.factor(data.combined$Pclass)
glimpse(data.combined)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
misses<-data.combined[which(str_detect(data.combined$Name,"Miss.")),]
head(misses)
mrses<-data.combined[which(str_detect(data.combined$Name,"Mrs.")),]
mrses[1:5,]
masters<-data.combined[which(str_detect(data.combined$Name,"Master")),]
masters[1:5,]
mr<-data.combined[which(str_detect(data.combined$Name,"Mr.")),]
mr[1:5,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
extractTitle<-function(Name){
  Name<-as.character(Name)
  if(length(grep("Miss.",Name))>0){
    return("Miss.")
  } else if (length(grep("Master.",Name))>0){
    return("Master.")
  } else if(length(grep("Mrs.",Name))>0){
    return("Mrs.")
  } else if(length(grep("Mr.", Name))>0){
    return("Mr.")
  } else {
    return("Other")
  }
}
titles<-NULL
for (i in 1:nrow(data.combined)){
  titles<-c(titles,extractTitle(data.combined[i,"Name"]))
}


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined$Title<-as.factor(titles)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined$SibSp<-as.factor(data.combined$SibSp)


## ----echo=T----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g2.5<-ggplot(data.combined[1:891,],aes(x=SibSp, fill=Survived))+geom_bar(width=0.5)+
facet_wrap(~Pclass+Title)+
  ggtitle("Pclass,Title")+
  xlab("Sibsp")+
  ylab("Total Count")+
  ylim(0,300)+
  labs(fill="Survived")

g2.5


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined$Parch<-as.factor(data.combined$Parch)


## ----echo=T----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g2.6<-ggplot(data.combined[1:891,],aes(x=Parch, fill=Survived))+geom_bar(width=1)+
   facet_wrap(~Pclass+Title)+
   ggtitle("Pclass,Title")+
   xlab("Parch")+
   ylab("Total Count")+
   ylim(0,300)+
   labs(fill="Survived")
  
g2.6


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  temp.sibsp<-c(train$SibSp,test$SibSp)
  temp.parch<-c(train$Parch,test$Parch)
  data.combined$Family.Size<-as.factor(temp.sibsp+temp.parch+1)

## ----echo=T----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g2.7<-ggplot(data.combined[1:891,],aes(x=Family.Size, fill=Survived))+geom_bar(width=1)+
    facet_wrap(~Pclass+Title)+
    ggtitle("Pclass,Title")+
    xlab("Family.Size")+
    ylab("Total Count")+
    ylim(0,300)+
    labs(fill="Survived")
  
  g2.7


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
subsmr<-subset(data.combined[1:891,], is.na(Age) & Title=="Mr.")
summary(subsmr)

## ----echo=T----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g3.1<-ggplot(subsmr,aes(x=Pclass,fill=Survived))+geom_bar(width=0.5)+facet_wrap(~Family.Size)
g3.1

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   data.combined2<-data.combined
   
   data.combined2$Embarked[c(62,830)]
   data.combined2$Embarked[c(62,830)]<-"C"
   data.combined2[1044,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   data.combined2$Fare[1044]<-median(data.combined2[data.combined2$Pclass==3 & data.combined2$Embarked=="S",]$Fare,na.rm=T)
   #Make variables factors into factors
   factor_vars <- c('PassengerId','Pclass','Sex','Embarked',
                    'Title','Family.Size')
   
   data.combined2[factor_vars] <- lapply(data.combined2[factor_vars], function(x) as.factor(x))

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   ### Setting a random seed
   set.seed(129)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mice_mod <- mice(data.combined2[, !names(data.combined2) %in% c('PassengerId','Name','Ticket','Cabin','Survived')], method='rf') 
### complete output saving

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   mice_output <- complete(mice_mod)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow=c(1,2))
   hist(data.combined2$Age, freq=F, main='Age: Original Data', 
        col='darkgreen', ylim=c(0,0.04))
   hist(mice_output$Age, freq=F, main='Age: MICE Output', 
        col='lightgreen', ylim=c(0,0.04))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined2$Age <- mice_output$Age


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data.combined2$Deck <- mice_output$Deck
summary(data.combined2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   train <- data.combined2[1:891,]
   test <- data.combined2[892:1309,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   set.seed(754)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf_model <- train(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + 
                           Fare + Embarked + Title,data=train,
                           method="ranger",
                           trControl = trainControl(method = "cv", number = 5, verboseIter = TRUE
))


