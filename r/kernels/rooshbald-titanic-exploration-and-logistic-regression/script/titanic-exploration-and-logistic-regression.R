## ----setup, include=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)


## ---- message = FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Load packages
library(ggplot2) # visualization
library(ggthemes) # visualization
library(dplyr) # data manipulation
library(rpart) # prediction
library(rpart.plot)


## ---- message = FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train <- read.csv("../input/train.csv")
test  <- read.csv("../input/test.csv")
test$Survived <- NA
combo  <- rbind(train, test) # bind training & test data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(combo)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(combo)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Name<- as.character(combo$Name)
strsplit(combo$Name[1],split = '[,.]')[[1]][2]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Title<- sapply(strsplit(combo$Name, split='[,.]'), function(x) (x[2]))
combo$Title <- sub(' ','',combo$Title) 
table(combo$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Title[combo$Title %in% c('Mme','Mlle')] <- 'Miss'
unique_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
combo$Title[combo$Title %in% unique_title]  <- 'Unique Title'


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(combo$Title, combo$Sex)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Fsize<- combo$SibSp + combo$Parch + 1
table(combo$Fsize)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Famcat <- case_when(
   combo$Fsize >=  0 & combo$Fsize <2   ~ "Single",
   combo$Fsize >=  2 & combo$Fsize <4   ~ "Small Family",
   combo$Fsize >=  4  ~ "Large Family"
)

combo$Famcat<- as.factor(combo$Famcat)
table(combo$Famcat)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 combo$Agecat <- case_when(
    combo$Age >=  0 & combo$Age <18   ~ "Child",
    combo$Age >=  18 & combo$Age <30   ~ "Under 30",
    combo$Age >=  30 & combo$Age <60  ~ "30-60",
 combo$Age >=  60~ "Senior"
 )


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Agecat<- factor(combo$Agecat, levels=c("Child", "Under 30", "30-60", "Senior"))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
is.na(combo) <- combo == ""
sapply(combo, function(x) sum(is.na(x)))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo %>% filter(is.na(Fare)) %>% head


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo %>%
   group_by(Embarked, Pclass) %>%
   na.omit() %>%    
   summarize(mean_fare = mean(Fare, na.rm = TRUE), n=n())


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Fare[1044]<- 11.02
combo[1044,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo %>% filter(is.na(Embarked)) %>% head


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
k <- ggplot(na.omit(combo), aes(x=factor(Embarked), fill=factor(Pclass)))
k + geom_bar( position="dodge")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
combo$Embarked[c(62,830)]<- "C"
table(combo$Embarked)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Agefit <- rpart(Age ~ Pclass + Sex + SibSp + Parch + Fare + Embarked + Title + Fsize, data = combo[!is.na(combo$Age),], method = 'anova')
combo$Age[is.na(combo$Age)] <- predict(Agefit, combo[is.na(combo$Age),])


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(na.omit(combo), aes(x=Sex, fill=factor(Survived))) +geom_bar(position="dodge")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(na.omit(combo), aes(x=Sex, fill=factor(Survived))) +geom_bar(position="dodge")  + facet_grid(".~Pclass")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
m <- ggplot(na.omit(combo), aes(x = Agecat, fill=factor(Survived)))
m + geom_bar(position = "stack")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
c1<- combo %>%
    group_by (Pclass, Agecat) %>%
     summarise(survived_ratio=mean(Survived,na.rm=TRUE))  %>%
     arrange(desc(survived_ratio))
c1


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train1<- combo[1:891,]
test1<- combo[892:1309,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train1$Pclass<- as.factor(train1$Pclass)
log3<- glm(data=train1, Survived ~ Pclass + Sex +Fare + Embarked + Title + Fsize +Agecat + Sex*Pclass, family="binomial")
summary(log3)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
test1$Pclass<- as.factor(test1$Pclass)
pred1 <- predict(log3, newdata = test1, type = "response")
survival1 = ifelse(pred1 > 0.5, 1, 0)

