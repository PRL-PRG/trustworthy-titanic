## ----setup, include=FALSE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(comment=NA, message=FALSE, warning=FALSE)


## ----message=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(tidyverse)
library(stringr)
library(forcats)
library(magrittr)
library(modelr)


## ----message=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train <- read_csv("../input/train.csv")
test <- read_csv("../input/test.csv")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data <- train %>%
  select(-Survived) %>%
  bind_rows(test) %>%
  mutate(is_train = factor(c(rep("train", nrow(train)),
                             rep("test", nrow(test)))),
         Survived = c(train$Survived, rep(NA, nrow(test)))
         )


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train %>% nrow() + 
  test %>% nrow() ==
  nrow(data)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% glimpse


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% summarize_all(n_distinct)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data <- data %>%
  select(-PassengerId)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data$Name %>% head(n = 50)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(title = 
           str_extract(Name, pattern = ",\\s\\w*\\.") %>%
           str_sub(start = 3, end = -2)
           ) -> data

data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  distinct(title)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  group_by(title) %>%
  count() %>%
  filter( n < 5) %>%
  walk(glimpse) %>%
  use_series(title) -> rare_title


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rare_title


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  select(title, Survived) %>%
  filter(title == "Col")
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
title_error <- c("Mme", "Mlle", "Jonkheer", NA)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  select(Name, title) %>%
  filter(title %in% title_error)
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  replace_na(
    list(title = "Countess")
  ) -> data

rare_title[is.na(rare_title)] <- "Countess"


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(title = fct_collapse(factor(title),
                              Rare_Title = rare_title)) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival <- function(...){
  data %>%
  group_by(...) %>% 
  summarise(avg_survival = mean(Survived, na.rm = TRUE),
            count = n(),
            na_survived = sum(is.na(Survived))) %>%
  arrange(avg_survival %>% desc())
}


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival(title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#View(data)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %<>%
  mutate(Pclass = factor(Pclass) %>%
           fct_recode(Upper = "1",
                      Middle = "2",
                      Lower = "3")) %>%
  rename(Status = Pclass)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(Port = str_extract(Ticket, pattern = ".*\\s") %>%
           str_sub(start = 1, end = -2)) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#View(data)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  group_by(Port) %>%
  summarize(mean_survival = mean(Survived, na.rm = T),
            count = n(),
            na = sum(is.na(Survived))) %>%
  arrange(mean_survival)
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

find_label <- function(pat){
  str_subset(data$Port, pattern = pat) %>% unique()
}

A <- find_label("^A")
Paris <- find_label("(PA)|(Pa)")
S <- find_label("^S\\.") %>% setdiff(Paris)
W <- find_label("^W")
CA_died <-  c("C.A./SOTON", "CA", "CA.")
C_survived <- c("C", "C.A.")
P <- find_label("^P")
SOTON <- find_label("SOTON")
STON <- find_label("STON")
F_ <- find_label("^F")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(Port = factor(Port)) %>%
  mutate(Port = fct_collapse(Port,
    A = A,
    Paris = Paris,
    S = S,
    W = W,
    CA_died = CA_died,
    C_survived = C_survived,
    P = P,
    SOTON = SOTON,
    STON = STON,
    F_ = F_
  )) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  group_by(Port) %>%
  count() %>%
  arrange(n)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  mutate(Port = fct_lump(Port, n = 10)) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  group_by(Port) %>%
  count() %>%
  arrange(n)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  select(Ticket, Port, Survived) %>%
  filter(is.na(Port)) %>%
  arrange(Ticket)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  mutate(Ticket_number = str_extract(Ticket, pattern = "(\\s[0-9]*)|(^[0-9]*$)") %>%
           as.integer() %>%
           as.character()) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

find_num <- function(num){
  str_subset(data$Ticket_number, pattern = paste("^", num, sep = "")) %>% unique()
}


data %>%
  mutate(Ticket_group = factor(Ticket_number) %>% 
           fct_collapse(
             `1` = find_num(1),
             `2` = find_num(2),
             `3` = find_num(3),
             `4` = find_num(4),
             `5` = find_num(5),
             `6` = find_num(6),
             `7` = find_num(7),
             `8` = find_num(8),
             `9` = find_num(9),
             other = NA
           )) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  group_by(Ticket_group) %>% 
  summarise(avg_survival = mean(Survived, na.rm = TRUE),
            count = n(),
            na_survived = sum(is.na(Survived))) -> explore_ticket

explore_ticket
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(data = explore_ticket %>% filter(Ticket_group %in% 1:3)) +
  geom_bar(stat = "identity", aes(x = Ticket_group, y = avg_survival, fill = Ticket_group)) +
  geom_text(mapping = aes(x = Ticket_group, y = .2, label = count))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#data %>% View()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  distinct(Embarked)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  filter(is.na(Embarked))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(Cabin_Letter = str_extract(Cabin, pattern = "^[A-Z]"),
         Cabin_Number = str_extract(Cabin, pattern = "[0-9]{1,3}"),
         Cabin_Multiple = str_length(Cabin) > 4) -> data
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival(Cabin_Letter) 


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival(Cabin_Number) %>% arrange(desc(count)) %>% arrange(Cabin_Number%>% as.integer())


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(caBIN = factor(Cabin_Number) %>%
           fct_collapse(
             `1-25` = str_c(1:25),
             `26-55` = str_c(26:55),
             `56-150` = str_c(56:150)
           )) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival(caBIN)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
explore_survival(Cabin_Multiple)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#View(data)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  mutate(Family_Size = SibSp + Parch) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

count_na <- function(){
data %>% 
  select(-Survived) %>%
  summarise_all(~sum(is.na(.))) %>% 
  gather(key = "column", value = "na_count") %>%
  filter(na_count > 0)
}

count_na()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate(Sex = factor(Sex),
         Survived = factor(Survived),
         Embarked = factor(Embarked),
         Cabin_Letter = factor(Cabin_Letter),
         Cabin_Number = factor(Cabin_Number),
         Cabin_Multiple = factor(Cabin_Multiple),
         ) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% head


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  mutate_if(is.factor, .funs = 'as.character') -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  replace_na(replace = list(
    Cabin_Letter = 0,
    Cabin_Number = 0, 
    Cabin_Multiple = 0, 
    Port = 0,
    Ticket_group = 0,
    caBIN = 0,
    Survived = 0
  )) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  mutate_if(is.character, .funs = "factor") -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# data %>% 
#   mutate_at(.vars = vars(Cabin_Letter, Cabin_Number, Cabin_Multiple, Port, Ticket_group, caBIN), .funs = "addNA") -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
count_na()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  select(-Name, -Ticket, -Cabin, -Ticket_number, -Cabin_Number) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
count_na()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  group_by(title) %>%
  summarise(mean_age = mean(Age
                            ,na.rm = T))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  filter(title == 'Master')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  group_by(title) %>% 
  mutate(Age = if_else(is.na(Age), median(Age, na.rm = T), Age)) %>%
  ungroup() -> data
  


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  group_by(Embarked) %>%
  count()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
 filter(!(Embarked %in% c("C", "Q", "S")))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% 
  replace_na(list(
    Embarked = 'S'
  )) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  filter(is.na(Fare))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  group_by(Status, Sex) %>%
  summarize(medFare = median(Fare, na.rm = T))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  group_by(Status, Sex) %>%
  mutate(Fare = ifelse( is.na(Fare), median(Fare, na.rm = T), Fare)) %>% 
  ungroup() -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#View(data)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
count_na()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% head()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>%
  select(is_train, Survived, everything()) -> data


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
data %>% head %>% colnames() %>% setdiff(c("is_train", "Survived")) -> x_predictors
y_target <- "Survived"

train <- data %>% filter(is_train == "train") %>% select(-is_train)
test <- data %>% filter(is_train == "test") %>% select(-is_train, -Survived)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_matrix(data = data, formula = Survived ~ . -1) -> model_data
model_train <- model_data %>% filter(is_traintrain == 1) %>% select(-is_traintest, -is_traintrain) %>% bind_cols(train['Survived'])
model_test <-  model_data %>% filter(is_traintrain == 0) %>% select(-is_traintest, -is_traintrain)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
head(train)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(h2o)
h2o.init()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train_h2o <- as.h2o(model_train)
test_h2o <- as.h2o(model_test)

data_split <- h2o.splitFrame(data = train_h2o, ratios = .75, seed = 1)

data_train <- data_split[[1]]
data_test <- data_split[[2]]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
deep_model <- h2o.deeplearning(
                               y = y_target,
                               #distribution = "bernoulli",
                               seed = 1,
                               training_frame = data_train)

rf_model <- h2o.randomForest(y = y_target,
                             seed = 1,
                             training_frame = data_train)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
gbm_model <- h2o.gbm(y = y_target,
                         seed = 1,
                         training_frame = data_train)

nb_model <- h2o.naiveBayes(y = y_target,
                         seed = 1,
                         training_frame = data_train)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
xgb_model <- h2o.xgboost(y = y_target,
                         seed = 1,
                         training_frame = data_train)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pred_deep <- h2o.predict(deep_model, newdata = data_test)[[1]]
pred_rf <- h2o.predict(rf_model, newdata = data_test)[[1]]
pred_gbm <- h2o.predict(gbm_model, newdata = data_test)[[1]]

h2o_predict <- function(model){
   h2o.predict(model, newdata = data_test)[[1]]
}

pred_nb <- h2o_predict(nb_model)
pred_xgb <- h2o_predict(xgb_model)

accuracy <- function(prediction){
  mean(data_test$Survived == prediction)
}


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
accuracy(pred_deep)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
accuracy(pred_rf)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
accuracy(pred_gbm)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
accuracy(pred_nb)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
accuracy(pred_xgb)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
final_model <- h2o.automl(y = y_target,
                         training_frame = train_h2o,
                         max_runtime_secs = 1100)
                         
# View the AutoML Leaderboard
lb <- final_model@leaderboard
lb                        
                         
pred_final <- h2o.predict(final_model@leader, newdata = test_h2o)[[1]] %>% as.data.frame()

submission <- data.frame("PassengerId" = read_csv("../input/test.csv")$PassengerId,
                  "Survived" = pred_final[[1]])
                  
write.csv(submission, file = 'TidyTitanic.csv', row.names = F)

