---
title: 'A Tweaking of Exploring the Titanic Dataset (Completely Megan L. Risdal with some tweaks)'
author: 'Bob Foreman'
date: '20 May 2017'
output:
  html_document:
    number_sections: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: readable
    highlight: tango
---

# Introduction

This is my first stab at a Kaggle script.  No real ideal what I'm doing.
So, I'm starting slowly but surely.  Going to pull in pieces of Megan's test and play to learn R.

## Load and check data

```{r, message = FALSE}
# Load packages
library('ggplot2') # visualization
library('ggthemes') # visualization
library('scales') # visualization
library('dplyr') # data manipulation
library('mice') # imputation
library('randomForest') # classification algorithm
```

Now that our packages are loaded, let's read in and take a peek at the data.

```{r, message=FALSE, warning=FALSE}
train <- read.csv('../input/train.csv', stringsAsFactors = F)
test  <- read.csv('../input/test.csv', stringsAsFactors = F)

full  <- bind_rows(train, test) # bind training & test data

# check data
str(full)
```

We've got a sense of our variables, their class type, and the first few observations of each. We know we're working with 1309 
observations of 12 variables. To make things a bit more explicit since a couple of the variable names aren't 100% illuminating,
here's what we've got to deal with:

Variable Name | Description
--------------|-------------
Survived      | Survived (1) or died (0)
Pclass        | Passenger's class
Name          | Passenger's name
Sex           | Passenger's sex
Age           | Passenger's age
SibSp         | Number of siblings/spouses aboard
Parch         | Number of parents/children aboard
Ticket        | Ticket number
Fare          | Fare
Cabin         | Cabin
Embarked      | Port of embarkation

see
# Feature Engineering
## What's in a name?

The first variable which catches my attention is **passenger name** because we can break it down into additional 
meaningful variables which can feed predictions or be used in the creation of additional new variables. 
For instance, **passenger title** is contained within the passenger name variable and we can use **surname** 
to represent families. Let's do some **feature engineering**!

```{r, message=FALSE, warning=FALSE}
# Grab title from passenger names
full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)

# Show title counts by sex
table(full$Sex, full$Title)

royal_title <- c('Lady', 'the Countess', 'Sir')
foreign_title <- c('Dona', 'Don', 'Jonkheer')
military_title <- c('Capt', 'Col', 'Major')

# Titles with very low cell counts to be combined to "rare" level
# BOB's TWEEK - Not including Rev in this list, based on another's recommendation... Good Revs didn't make it


rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Sir', 'Jonkheer')


# Also reassign mlle, ms, and mme accordingly
full$Title[full$Title == 'Mlle']        <- 'Miss' 
full$Title[full$Title == 'Ms']          <- 'Miss'
full$Title[full$Title == 'Mme']         <- 'Mrs' 
full$Title[full$Title %in% royal_title]  <- 'Royal'
full$Title[full$Title %in% military_title]  <- 'Military'
full$Title[full$Title %in% foreign_title]  <- 'Exotic'

# Show title counts by sex again
table(full$Sex, full$Title)

# Finally, grab surname from passenger name
full$Surname <- sapply(full$Name,  
                      function(x) strsplit(x, split = '[,.]')[[1]][1])
```

```{r results='asis'}
cat(paste('We have <b>', nlevels(factor(full$Surname)), '</b> unique surnames. I would be interested to infer ethnicity 
based on surname (Said Megan - Id have no idea how to do that)'))
```

## Do families sink or swim together?

Now that we've taken care of splitting passenger name into some new variables, we can take it a 
step further and make some new family variables. First we're going to make a **family size** variable 
based on number of siblings/spouse(s) (maybe someone has more than one spouse?) and number of children/parents. 

```{r}
# Create a family size variable including the passenger themselves
full$Fsize <- full$SibSp + full$Parch + 1

# Create a family variable 
full$Family <- paste(full$Surname, full$Fsize, sep='_')
```

Let's see what survival looks like by Title

```{r, message=FALSE, warning=FALSE}
# Use ggplot2 to visualize the relationship between Title & survival
ggplot(full[1:891,], aes(x = Title, fill = factor(Survived))) +
  geom_bar(stat='count', position='dodge') +
  labs(x = 'Title') +
  theme_few()
```

What does our family size variable look like? To help us understand how it may relate to survival, let's plot it among the training data.

```{r, message=FALSE, warning=FALSE}
# Use ggplot2 to visualize the relationship between family size & survival
ggplot(full[1:891,], aes(x = Fsize, fill = factor(Survived))) +
  geom_bar(stat='count', position='dodge') +
  scale_x_continuous(breaks=c(1:11)) +
  labs(x = 'Family Size') +
  theme_few()
```

Ah hah. We can see that there's a survival penalty to singletons and those with family sizes above 4.
We can collapse this variable into three levels which will be helpful since there are comparatively 
fewer large families. Let's create a **discretized family size** variable.

```{r}
# Discretize family size
full$FsizeD[full$Fsize == 1] <- 'singleton'
full$FsizeD[full$Fsize > 1] <- 'pairs'
full$FsizeD[full$Fsize > 2] <- 'micro'
full$FsizeD[full$Fsize > 4] <- 'mid'
full$FsizeD[full$Fsize > 7] <- 'large'


# Show family size by survival using the same plot types

# Use ggplot2 to visualize the relationship between family size & survival
ggplot(full[1:891,], aes(x = FsizeD, fill = factor(Survived))) +
  geom_bar(stat='count', position='dodge') +
  labs(x = 'Family Size D') +
  theme_few()
```

The mosaic plot shows that we preserve our rule that there's a survival penalty among singletons and large families, 
but a benefit for passengers in small families. I want to do something further with our age variable, 
but `r sum(is.na(full$Age))` rows have missing age values, so we will have to wait until after we address missingness.

## Treat a few more variables ...

What's left? There's probably some potentially useful information in the **passenger cabin** variable including 
about their **deck**. Let's take a look.

```{r}
# This variable appears to have a lot of missing values
full$Cabin[1:28]

# The first character is the deck. For example:
strsplit(full$Cabin[2], NULL)[[1]]

# Create a Deck variable. Get passenger deck A - F:
full$Deck<-factor(sapply(full$Cabin, function(x) strsplit(x, NULL)[[1]][1]))

# Use ggplot2 to visualize the relationship between family size & survival
ggplot(full[1:891,], aes(x = Deck, fill = factor(Survived))) +
  geom_bar(stat='count', position='dodge') +
  labs(x = 'Deck') +
  theme_few()
  
# Hum, who has a known Deck?
table(full$Pclass, full$Deck)


#Did we look at survival by Class?
# Use ggplot2 to visualize the relationship between Class & survival
ggplot(full[1:891,], aes(x = Pclass, fill = factor(Survived))) +
  geom_bar(stat='count', position='dodge') +
  labs(x = 'Class') +
  theme_few()
  
  
#How may did the classes do, that had a known cabin?
table(full$Survived[!is.na(full$Deck)], full$Pclass[!is.na(full$Deck)])
  
```

There's more that likely could be done here including looking into cabins with multiple rooms listed 
(e.g., row 28: "C23 C25 C27"), but given the sparseness of the column we'll stop here.

# Missingness

Now we're ready to start exploring missing data and rectifying it through imputation.
There are a number of different ways we could go about doing this. Given the small size of the
dataset, we probably should not opt for deleting either entire observations (rows) or variables (columns)
containing missing values. We're left with the option of either replacing missing values with a sensible
values given the distribution of the data, e.g., the mean, median or mode. Finally, we could go with prediction.
We'll use both of the two latter methods and I'll rely on some data visualization to guide our decisions.

## Sensible value imputation

```{r}
# Passengers 62 and 830 are missing Embarkment
full[c(62, 830, 1, 2, 3), 'Embarked']
full[c(62, 830, 1, 2, 3), 'Fare']
full[c(62, 830, 1, 2, 3), 'Age']
full[c(62, 830, 1, 2, 3), 'Pclass']
full[c(62, 830, 1, 2, 3), 'Deck']
```

```{r results='asis'}
cat(paste('We will infer their values for **embarkment** based on present data that we can imagine
may be relevant: **passenger class** and **fare**. We see that they paid<b> $', full[c(62, 830), 'Fare'][[1]][1],
'</b>and<b> $', full[c(62, 830), 'Fare'][[2]][1], '</b>respectively and their classes are<b>', full[c(62, 830),
'Pclass'][[1]][1], '</b>and<b>', full[c(62, 830), 'Pclass'][[2]][1], '</b>. So from where did they embark?'))
```

```{r, message=FALSE, warning=FALSE}
# Get rid of our missing passenger IDs
embark_fare <- full %>%
  filter(PassengerId != 62 & PassengerId != 830)

# Use ggplot2 to visualize embarkment, passenger class, & median fare
ggplot(embark_fare, aes(x = Embarked, y = Fare, fill = factor(Pclass))) +
  geom_boxplot() +
  geom_hline(aes(yintercept=80), 
    colour='red', linetype='dashed', lwd=2) +
  scale_y_continuous(labels=dollar_format()) +
  theme_few()
```

