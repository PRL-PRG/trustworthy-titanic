---
title: "Titanic - Kaggle"
author: "Kishore Vancheeshwaran"
date: "28 November 2017"
output:
  html_document:
    number_sections: false
    toc: true
    fig_width: 7
    fig_height: 5
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# Introduction

This is my first kaggle dataset to be worked on. I have learnt a lot of the nuances of R by working on this dataset. I know only *decision trees* and *random forests* algorithms so far. So I will be building a prediction model based on *decision trees* for now. If there's any input from anyone as to how I can modify or improve myself, please let me know in the comments. :)

## Load libraries
```{r, message=FALSE}
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(mice)
library(randomForest)
library(mice)
library(tree)
```

## Load and observe dataset
```{r}
titanic_train <- read.csv('../input/train.csv',
                          stringsAsFactors = FALSE)
titanic_test <- read.csv('../input/test.csv',
                         stringsAsFactors = FALSE)

str(titanic_train)
str(titanic_test)
```

I came to know only recently that whatever actions I perform on the training data, should be performed on the testing data too. Hence, to me, it makes sense that I could just as well combine both the data for now, and then split it up in the end when I do the tests. I can do this by using `bind_rows` from `dplyr`.

```{r}
titanic <- bind_rows(titanic_train, titanic_test)

str(titanic)

head(titanic)

tail(titanic)

summary(titanic)
```

Description of variables as given on kaggle:

Variable Name | Description
--------------|-------------
Survived      | Survived (1) or died (0)
Pclass        | Passenger's class
Name          | Passenger's name
Sex           | Passenger's sex
Age           | Passenger's age
SibSp         | Number of siblings/spouses aboard
Parch         | Number of parents/children aboard
Ticket        | Ticket number
Fare          | Fare
Cabin         | Cabin
Embarked      | Port of boarding

# Exploration

## Checking Null values
```{r}
sapply(titanic, function(x) sum(is.na(x)))
```

Age has a lot of null values, so does Fare. When we look at the structure, we see that the Cabin has `""` as values, which we can assume as blanks or nulls.

## Feature engineering

Looking at the data, we can try to mutate newer variables based on the existing ones. You can mutate the **titles** of the *Name*, **surnames** of *Name*, **Family size** from *SibSp* & *Parch*,

### Family size

We can't differentiate between spouse and sibling from the given data, so splitting it further is impossible. Similarly, we can't differentiate parents/children aboard because the data doesn't go into the granularity of how many parents per child, or how many children per parent. Hence we are forced to take the sum of both the variables and create a new one **family size** - `fam_size`.

```{r}
titanic$fam_size <- titanic$SibSp + titanic$Parch + 1
```

Trying out relation between family size and survival,
```{r}
ggplot(titanic[1:891, ],
       aes(fam_size,
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  scale_x_continuous(breaks = 0:11) +
  ggtitle("Family size vs No of survivors") +
  xlab("Family Size") +
  ylab("No of survivors") +
  labs(fill = "Survived")
```

People who were single, died more in comparison to people who had at least 1 family member. This takes a turn, again when family size is greater than 3.

So we will create another feature/variable, which categorizes them accordingly.
```{r}

unique(titanic$fam_size)

titanic$fam_type[titanic$fam_size == 1] <- "single"
titanic$fam_type[titanic$fam_size > 1 & titanic$fam_size < 4] <- "few"
titanic$fam_type[titanic$fam_size > 3] <- "many"

ggplot(titanic[1:891, ],
       aes(fam_type,
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  ggtitle("Family type vs No of survivors") +
  xlab("Family Type") +
  ylab("No of survivors") +
  labs(fill = "Survived")
```

This plot makes it much clearer that families with fewer members, but not singles, survived more than families with many members or single people.

### Exploring each feature(s)

This shows in which deck each passenger stayed.
```{r}
head(titanic$Cabin)
```

Oops, it has blank values. Assuming the first letter to be the **Deck** level, we will try to mutate that into another column.
```{r}
titanic$Deck <- factor(sapply(titanic$Cabin, function(x) strsplit(x, NULL)[[1]][1]))
unique(titanic$Deck)

ggplot(na.omit(titanic[1:891, ]),
       aes(Survived,
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  facet_wrap(~Deck) +
  scale_x_continuous(breaks = 0:1) +
  ggtitle("Deck level vs No of survivors") +
  ylab("No of survivors") +
  labs(fill = "Survived") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank())
```

Checking the survivors according to class
```{r}
ggplot(titanic[1:891, ],
       aes(Survived,
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  facet_wrap(~Pclass) +
  scale_x_continuous(breaks = 0:1) +
  ggtitle("Survivors in each class") +
  xlab("Class") +
  ylab("No of survivors") +
  labs(fill = "Survived") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  
```

Wow.. First class people were able to survive more, compared to the people who could afford only the third class where many died :(

Checking by age, gender, fare: We see that more females survived.
```{r warning=FALSE}
ggplot(titanic[1:891, ],
       aes(Fare, Age)) +
  geom_point(aes(colour = factor(Survived))) +
  facet_wrap(~Sex) +
  ggtitle("Survivors by gender, age vs fare") +
  labs(colour = "Survived")
```

Passengers per boarding point who survived:
```{r}
ggplot(titanic[1:891, ],
       aes(factor(Embarked),
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  ggtitle("Survivors according to boarding point") +
  xlab("Boarding point") +
  ylab("No of survivors") +
  labs(fill = "Survived")
```

Wow, so.. people who boarded from Southampton were more likely to die.. Interesting.

Next, checking gender for each class who survived:
```{r}
ggplot(titanic[1:891, ] %>% filter(Survived == 1),
       aes(Sex)) +
  geom_bar(stat = "count",
           position = "dodge") +
  facet_grid(~Pclass) +
  ggtitle("Survivors according to gender for each class") +
  ylab("No of people")
```

It seems that there are more female survivors, as seen earlier too.

### Exploring the names

Observing the names, we see that each person has a *title* for themselves. We can try to extract them and put them in a new variable **title** - `title`.
```{r}
head(titanic$Name)

titanic$title <- gsub('(.*, )|(\\..*)', '', titanic$Name)

unique(titanic$title)

table(titanic$title, titanic$Sex)

rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')


titanic$title[titanic$title == 'Mlle']        <- 'Miss' 
titanic$title[titanic$title == 'Ms']          <- 'Miss'
titanic$title[titanic$title == 'Mme']         <- 'Mrs' 
titanic$title[titanic$title %in% rare_title]  <- 'Rare Title'

table(titanic$title, titanic$Sex)
```

We can also get the surnames from the **Name**.
```{r}
titanic$surname <- sapply(titanic$Name, function(x) strsplit(x, split = '[,.]')[[1]][1])

head(titanic$surname)
length(unique(titanic$surname))
```

Wow, there are 875 unique surnames. I don't know how to proceed with this, other than manually searching and sorting them from the internet. If anyone knows a better way, please let me know.

# Missing values

## Logical imputation

There are some missing values in **Embarked**.
```{r}

unique(titanic$Embarked)

which(titanic$Embarked == "")

titanic[which(titanic$Embarked == ""), ]

titanic[c(62,830), ]

titanic %>% filter(PassengerId != 62 & PassengerId != 830 & Pclass == 1) %>% group_by(Embarked) %>% summarise(n = median(Fare))
```

Since median fare for class 1 passenger is close to 80 (ie 77), we can assume that the passenger leaves from "C".
```{r}
titanic$Embarked[c(62,830)] <- "C"
```

But hey, according to [Encyclopedia Titanica](http://www.encyclopedia-titanica.org/titanic-survivor/amelia-icard.html), they both boarded at Southampton. So, cross referencing with facts, we have to change this.
```{r}
titanic$Embarked[c(62,830)] <- "S"
```


Now we'll plot the survivors according to boarding point again.
```{r}
ggplot(titanic[1:891, ],
       aes(factor(Embarked),
           fill = factor(Survived))) +
  geom_bar(stat = "count",
           position = "dodge") +
  ggtitle("Survivors according to boarding point") +
  xlab("Boarding point") +
  ylab("No of survivors") +
  labs(fill = "Survived")
```

### Fare imputation

There is one null value in Fare
```{r}
sum(is.na(titanic$Fare))
```

We will try to impute it based on the info on that record.
```{r}
which(is.na(titanic$Fare))

titanic[which(is.na(titanic$Fare)), ]

titanic %>% filter(Pclass == 3 & Embarked == "S") %>% summarise(n = median(Fare, na.rm = TRUE))

ggplot(titanic %>% filter(Pclass == 3 & Embarked == "S"),
       aes(x = Fare)) +
  geom_density() +
  geom_vline(xintercept = 8)

titanic$Fare[which(is.na(titanic$Fare))] <- median(titanic[titanic$Pclass == 3 & titanic$Embarked == "S", ]$Fare, na.rm = TRUE)

titanic[1044, "Fare"]
```

### Cabin imputation
```{r}
str(titanic)

titanic %>% group_by(Pclass, Deck, Embarked) %>% summarise(mean = mean(Fare, na.rm = TRUE))
titanic %>% group_by(Pclass, Deck, Embarked) %>% summarise(med = median(Fare, na.rm = TRUE))
titanic %>% group_by(Pclass, Deck, Embarked) %>% summarise(min = min(Fare, na.rm = TRUE))
titanic %>% group_by(Pclass, Deck, Embarked) %>% summarise(max = max(Fare, na.rm = TRUE))
```

The idea is that it might be possible to impute the **Deck** variable, with the **Pclass**, **Embarked**, **Fare**, and if possible **Ticket** too. Of course, it is easier to use packages like `mice` or `missForest` but I prefer implementing some logic rather than let a random prediction take its course. If anyone has any suggestions on how I can proceed for this, please let me know. I will be skipping this step for now.


### Age imputation

For imputing age, there are many methods. Two such methods I am aware of are using MICE and randomForest. We'll define a new column, which says the type of a person's age, i.e. `age_type` will be *child* or *adult* or *senior*. A third and fourth method which I propose is to use the median age for each class gender wise, and to use ages selected randomly from each class gender wise.

```{r}
quantile(titanic[titanic$title == "Mr", ]$Age, na.rm = TRUE)
quantile(titanic[titanic$title == "Mrs", ]$Age, na.rm = TRUE)

quantile(titanic[titanic$title == "Mr", ]$Age, na.rm = TRUE, .05)
quantile(titanic[titanic$title == "Mrs", ]$Age, na.rm = TRUE, .05)
```

We see that people got married at a very young age. Thus, we will use 16 as a good partition for classifying whether or not a person is a child/adult and 60 for adult/senior citizen partition.

```{r}
titanic <- titanic %>% mutate(age_type = ifelse(Age < 16, "Child", ifelse(Age < 60, "Adult", "Senior")))

titanic %>% group_by(Pclass, age_type, Sex) %>% summarise(age = median(Age, na.rm = TRUE))

titanic %>% filter(Age < 16) %>% group_by(Pclass, Sex) %>% summarise(age = median(Age, na.rm = TRUE), age_mean = mean(Age, na.rm = TRUE), age_sd = sd(Age, na.rm = TRUE))

titanic %>% filter(Age >= 16 & Age < 60) %>% group_by(Pclass, Sex) %>% summarise(age = median(Age, na.rm = TRUE), age_mean = mean(Age, na.rm = TRUE), age_sd = sd(Age, na.rm = TRUE))

titanic %>% filter(Age >= 60) %>% group_by(Pclass, Sex) %>% summarise(age = median(Age, na.rm = TRUE), age_mean = mean(Age, na.rm = TRUE), age_sd = sd(Age, na.rm = TRUE))
```

We will use the mice package to impute the age for now.

```{r}
sum(is.na(titanic$Age))

mice_titanic <- mice(data = titanic[ , !names(titanic) %in% c("PassengerId", "Survived", "Name", "Ticket", "Cabin", "surname", "age_type")], m = 3, method = "rf", maxit = 20, seed = 765)

mice_titanic_op <- complete(mice_titanic)

ggplot() +
  geom_density(aes(x = titanic$Age, col = "blue")) +
  geom_density(aes(x = mice_titanic_op$Age, col = "red")) +
  ggtitle("Distribution of age in original and imputed data set") +
  xlab("Age") +
  ylab("Density") +
  labs(col = "Colour") +
  scale_color_manual(labels = c("titanic", "mice"), values = c("blue", "red"))
```

The distribution looks good. So we will impute the data.
```{r}
titanic$Age <- mice_titanic_op$Age
```


### Age type with imputed ages
```{r}
titanic <- titanic %>% mutate(age_type = ifelse(Age < 16, "Child", ifelse(Age < 60, "Adult", "Senior")))
```


# Prediction models

Now we will build a prediction model with decision tree.
```{r}
titanic_factors <- titanic

str(titanic_factors)
titanic_factors$Survived <- as.factor(titanic_factors$Survived)
titanic_factors$Pclass <- as.factor(titanic_factors$Pclass)
titanic_factors$Sex <- as.factor(titanic_factors$Sex)
titanic_factors$Embarked <- as.factor(titanic_factors$Embarked)
titanic_factors$fam_type <- as.factor(titanic_factors$fam_type)
titanic_factors$title <- as.factor(titanic_factors$title)
titanic_factors$age_type <- as.factor(titanic_factors$age_type)

str(titanic_factors)

titanic_train <- titanic_factors[1:891, ]
titanic_test <- titanic_factors[892:1309, ]

titanic_model_4 <- tree(Survived ~ Pclass + Sex + Age + SibSp + Parch + Embarked + fam_type + title + age_type + Fare, data = titanic_train )

titanic_tree_pred <- predict(titanic_model_4, titanic_test, type = "class")

submission <- data.frame(PassengerId = titanic_test$PassengerId, Survived = titanic_tree_pred)

write.csv(submission, file = "submission_tree.csv", row.names = FALSE)
```

```{r, echo = FALSE}
# titanic_model_3 <- randomForest(Survived ~ Pclass + Sex + Age + SibSp + Parch + Embarked + fam_type + title + age_type + Fare, data = titanic_train )
# 
# titanic_rf_pred <- predict(titanic_model_3, titanic_test, type = "class")
# 
# submission <- data.frame(PassengerId = titanic_test$PassengerId, Survived = titanic_rf_pred)
# 
# write.csv(submission, file = "submission_rf.csv", row.names = FALSE)

# titanic_model_1 <- tree(Survived~ Pclass+Sex+Age+SibSp+Fare, data = titanic_train)
# titanic_tree_pred_1 <- predict(titanic_model_1, titanic_test, type = "class")
# 
# submission <- titanic_test
# 
# submission$Survived <- titanic_tree_pred_1
# 
# submission2 <- submission[,c("PassengerId", "Survived")]
# 
# write.csv(x = submission2,file = "submission_2.csv", row.names = FALSE)

```

# Conclusion

This was my first kaggle submission. I learnt a lot. The entire process can be improved in many many ways. Looking forward to suggestions from people. :)


## Credits

Thank you for helping me out [Kumar Halake](https://www.kaggle.com/kumarhalake), [Megan Risdal's notebook](https://www.kaggle.com/mrisdal/exploring-survival-on-the-titanic/notebook), [Hari Anantaraman](https://www.kaggle.com/clairvoyance), [Deepu Dilip](https://www.kaggle.com/dd2908).














