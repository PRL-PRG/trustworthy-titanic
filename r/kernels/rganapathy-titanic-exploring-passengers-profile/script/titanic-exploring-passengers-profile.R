## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(mice) #For Missing Value imputation
library(MASS) 
library(ggplot2)
library(grid)
library(gridExtra)
library(randomForest)
library(e1071)
library(caret)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
input=read.csv("../input/train.csv",stringsAsFactors = FALSE)
str(input)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
head(input)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(input)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
input[input==""]=NA
print("Total count of missing values in each column:")
apply(apply(input,2,is.na),2,sum)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
input$Title <- gsub('(.*, )|(\\..*)', '', input$Name)
table(input$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')

# Also reassign mlle, ms, and mme accordingly
input$Title[input$Title == 'Mlle']        <- 'Miss' 
input$Title[input$Title == 'Ms']          <- 'Miss'
input$Title[input$Title == 'Mme']         <- 'Mrs' 
input$Title[input$Title %in% rare_title]  <- 'Others'
head(input)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
input$Deck=substr(input$Cabin,1,1)
input$fsize=input$SibSp+input$Parch
input$with_family=ifelse(input$fsize==0,0,1)
head(input)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
input_features=input[,c("Survived","Pclass","Sex","Age","SibSp","Parch","Fare","Embarked","Title","Deck","fsize","with_family")]
factor_vars <- c("Survived","Pclass","Sex","Embarked","Title","Deck","with_family")
input_features[factor_vars] <- lapply(input_features[factor_vars], function(x) as.factor(x))
str(input_features)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(129)
imp=mice(input_features,m=5, meth='rf')
dat=complete(imp)
summary(imp)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
print("Total number of missing values in each column")
apply(apply(dat,2,is.na),2,sum)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow =c(1,2))
hist(input_features$Age,main= "Before imputation")
hist(dat$Age,main="After imputation")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow =c(1,3))
hist(dat$Age)
hist(dat$Fare)
hist(dat$fsize)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
p21=ggplot(dat, aes(Sex, fill = factor(Survived))) + geom_histogram(stat="count")
p22=ggplot(dat, aes(Sex, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
grid.arrange(p21,p22, ncol = 2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
p11=ggplot(dat, aes(Pclass, fill = factor(Survived))) + geom_histogram(stat="count")
p12=ggplot(dat, aes(Pclass, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
grid.arrange(p11,p12, ncol = 2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(dat, aes(Embarked, fill = factor(Survived))) + geom_histogram(stat="count")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
p41=ggplot(dat, aes(Deck, fill = factor(Survived))) + geom_histogram(stat="count")
p42=ggplot(dat, aes(Deck, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
grid.arrange(p41,p42, ncol = 2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
p51=ggplot(dat, aes(Title, fill = factor(Survived))) + geom_histogram(stat="count")
p52=ggplot(dat, aes(Title, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
grid.arrange(p51,p52, ncol = 2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
p61=ggplot(dat, aes(with_family, fill = factor(Survived))) + geom_histogram(stat="count")
p62=ggplot(dat, aes(with_family, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
p63=ggplot(dat, aes(fsize, fill = factor(Survived))) + geom_histogram(stat="count")
p64=ggplot(dat, aes(fsize, fill = factor(Survived))) + geom_bar(position="fill")+labs(y="Proportion")
grid.arrange(p61,p62,p63,p64,ncol = 2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(dat, aes(Survived, fill = factor(Survived))) + geom_histogram(stat="count") + facet_grid(Embarked~Pclass)#


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(dat, aes(Survived, fill = factor(Survived))) + geom_histogram(stat="count") + facet_grid(Deck~Pclass)#


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
chisq.test(dat$Survived,dat$Pclass)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(123)
train_size=floor(0.70*nrow(dat))
train_ind=sample(seq_len(nrow(dat)),size = train_size)
train=dat[train_ind,]
test=dat[-train_ind,]
print("Train dataset dimension:")
dim(train)
print("Test dataset Dimension:")
dim(test)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf.model=randomForest(Survived~.,data = train,importance=TRUE)
rf.model


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
varImpPlot(rf.model)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf.pred=predict(rf.model,newdata=test)
rf.pred


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
confusionMatrix(rf.pred,test$Survived)

