{"cells":[{"metadata":{"_uuid":"91bb1291bf35af78dff93b47443c4068ad6d7521","_execution_state":"idle","trusted":true},"cell_type":"code","source":"## Importing packages\n\n# This R environment comes with all of CRAN and many other helpful packages preinstalled.\n# You can see which packages are installed by checking out the kaggle/rstats docker image: \n# https://github.com/kaggle/docker-rstats\n\nlibrary(tidyverse) # metapackage with lots of helpful functions\n\n## Running code\n\n# In a notebook, you can run a single code cell by clicking in the cell and then hitting \n# the blue arrow to the left, or by clicking in the cell and pressing Shift+Enter. In a script, \n# you can run code by highlighting the code you want to run and then clicking the blue arrow\n# at the bottom of this window.\n\n## Reading in files\n\n# You can access files from datasets you've added to this kernel in the \"../input/\" directory.\n# You can see the files added to this kernel by running the code below. \n\nlist.files(path = \"../input\")\ntrain <- read.csv(\"../input/train.csv\")\ntest <- read.csv(\"../input/test.csv\")\nlibrary(rpart)\nlibrary(stringr)\nlibrary(doSNOW)\n library(randomForest)\n library(rattle)\n library(rpart.plot)\nlibrary(RColorBrewer)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(party)\nlibrary(rpart.plot)\nlibrary(xgboost)\nlibrary(drat)\nlibrary(beanplot)\n\n\n\nlibrary(RCurl, quietly = T)\n\nlibrary(tidyverse, quietly = T)\n\n\nlibrary(ggplot2)\nlibrary(gridExtra, quietly = T)\nlibrary(beanplot, quietly = T)\nlibrary(caret, quietly = T)\nlibrary(stringr, quietly = T)\nlibrary(party, quietly = T)\nlibrary(xgboost, quietly = T)\nlibrary(skimr, quietly = T)\nlibrary(alluvial, quietly = T)\nlibrary(pROC, quietly = T)\nlibrary(ggrepel, quietly = T)\nlibrary(Amelia)\n\n## Saving data\n\n# If you save any files or images, these will be put in the \"output\" directory. You \n# can see the output directory by committing and running your kernel (using the \n# Commit & Run button) and then checking out the compiled version of your kernel.","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"e92dab7f9f1a502545e76978e6c2a144d3c5dced"},"cell_type":"code","source":"## changing Survivde / dead instead of 0 -1\nprep_data <- function(D) {\n    if (!is.null(D$Survived)) {\n        D$Survived <- factor(D$Survived,\n                             levels = c(1, 0),\n                             labels = c('Survived', 'Dead'))\n    }\n    D$Pclass <- factor(D$Pclass,\n                       levels = c(1, 2, 3),\n                       labels = c('P1', 'P2', 'P3'))\n   \n    D\n}\ntrain <- prep_data(train)\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"089987bf8baa0d624835e0f807c9f4b866ab0e8a"},"cell_type":"code","source":"#Basic  EDA\nprop.table(table(train$Survived))\nsummary(train$Sex)\nsummary(test$Sex)\nhistogram(train$Sex)\nhistogram(test$Sex)\n prop.table(table(train$Sex, train$Survived))\n\nprop.table(table(train$Sex, train$Survived), 1)\n\nsummary(train$Age)\nsummary(test$Age)\n## cont\np1 <- ggplot(data = train, aes(x = Age)) + geom_histogram(aes(fill = Survived), bins = 40) + coord_flip()\np2 <- ggplot(data = train, aes(x = Fare)) + geom_histogram(aes(fill = Survived), bins = 40) + coord_flip()\ngrid.arrange(p1, p2, nrow = 1)\n\n","execution_count":null,"outputs":[]},{"metadata":{"_kg_hide-input":true,"trusted":true,"_uuid":"33b2bef4a97e13b436b6bb850d8c8b345fd3350f"},"cell_type":"code","source":"## EDa categorical\nget_legend <- function(myggplot) {\n    tmp <- ggplot_gtable(ggplot_build(myggplot))\n    leg <- which(sapply(tmp$grobs, function(x) x$name) == \"guide-box\")\n    legend <- tmp$grobs[[leg]]\n    return(legend)\n}\np <- lapply(X = c('Pclass', 'Sex', 'SibSp', 'Parch', 'Embarked'),\n            FUN = function(x) ggplot(data = train) +\n                aes_string(x = x, fill = 'Survived') +\n                    geom_bar(position = \"dodge\") +\n                        theme(legend.position = \"none\"))\n            legend <- get_legend(ggplot(data = train, aes(x = Pclass, fill = Survived)) + geom_bar())\ngrid.arrange(p[[1]], p[[2]], p[[3]], p[[4]], p[[5]],\n             legend, layout_matrix = cbind(c(1, 2, 3),\n                                          c(4, 5, 3),\n                                          c(6, 6, 6)),\n             widths = c(3, 3, 1))\n\n                        ##beanplots\nggplot(train, aes(y = Age, x = Pclass)) + geom_boxplot(aes(fill = Survived)) + theme_bw()\n\nbeanplot(Age ~ Survived * Pclass, side = 'b', train, col = list('yellow', 'orange'),\n         border = c('yellow2', 'darkorange'), ll = 0.05, boxwex = .5,\n         main = 'Passenger survival by pclass and Age', xlab = 'Passenger Class', ylab = 'Age')\nlegend('topright', fill = c('yellow', 'orange'), legend = c(\"Dead\", \"Survived\"), bty = 'n', cex = .8)\n\n\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"d65ce9e2d4e42b039b86db8057992af57a7177e5"},"cell_type":"code","source":"## family  Eda\nggplot(train, aes(y = SibSp, x = Parch)) +\n    geom_jitter(aes(color = Survived, shape = Pclass)) +\n    theme_bw() +\n    scale_shape(solid = F) +\n    geom_vline(xintercept = 3, color = 'darkred', lty = 2) +\n    geom_hline(yintercept = 3, color = 'red', lty = 2)\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"f67f515130c8097e9e8e6ce813ee9244fb4dcb1c"},"cell_type":"code","source":"#aluvial\ntrain %>%\n    mutate(Age_Group = case_when(\n        Age < 18 ~ 'Child',\n        Age >= 18 ~ 'Adult'\n    )) %>%\n    group_by(Survived, Sex, Pclass, Age_Group) %>%\n    summarise(N = n()) %>%\n    ungroup %>%\n    na.omit -> alluvial_table\n\nalluvial(alluvial_table[, c(-5)],\n         freq = alluvial_table$N,\n         cex = 0.8,\n         col = ifelse(alluvial_table$Survived == \"Survived\", \"blue\", \"forestgreen\"))\n\n\nggplot(train, aes(x = Sex , y = Age)) +\n    geom_jitter(shape = 21, alpha = .6, col = 'blue') +\n    stat_summary(aes(y = Age, group = 1), fun.y = median, colour = \"red\", geom = \"point\", group = 1) +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = \"none\") +\n    labs(caption = 'red points are median values')\n\nggplot(combi, aes(x = Sex, y = SimpTitle)) +\n    geom_jitter(shape = 21, alpha = .6, col = 'blue') +\n    stat_summary(aes(y = Age, group = 1), fun.y = median, colour = \"red\", geom = \"point\", group = 1) +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = \"none\") +\n    labs(caption = 'red points are median values')\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"5aa6ad5e205cf600b53b4d2798d1f029c37c18b5"},"cell_type":"code","source":"\n\n##combine datasets\n\ntest$Survived <- NA\ntest<-prep_data(test)\ncombi <- (rbind(train, test))\ncombi$Survived<-as.factor(combi$Survived)","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"7eb8000b5f523f169e75774a2b5e9a6367e3bff3"},"cell_type":"code","source":"## getting title\n\ncombi$Name <- as.character(combi$Name)\n\nstrsplit(combi$Name[1], split = '[,.]')\nstrsplit(combi$Name[1], split = '[,.]')[[1]]\nstrsplit(combi$Name[1], split = '[,.]')[[1]][2]\n\n\n\n\ncombi$Title <- sapply(combi$Name, FUN = function(x) { strsplit(x, split = '[,.]')[[1]][2] })\ncombi$Title <- sub(' ', '', combi$Title)\ntable(combi$Title)\n\nggplot(combi, aes(Title)) +\n    geom_bar()\n\n\n\n\n\ncombi$Title[combi$Title %in% c('Ms', 'Miss')] <- 'Miss'\ncombi$Title[combi$Title %in% c('Mme', 'Mlle')] <- 'Miss'\ncombi$Title[combi$Title %in% c('Capt', 'Don', 'Major', 'Sir')] <- 'Sir'\ncombi$Title[combi$Title %in% c('Dona', 'Lady', 'the Countess', 'Jonkheer')] <- 'Mrs'\n\ncombi <- combi %>%\n    mutate(SimpTitle = sub(\".*?(Mr|Miss|Mrs|Master|$).*\", \"\\\\1\", Title))\n\nweirdos <- combi[combi$SimpTitle == \"\", c(\"PassengerId\", \"Survived\", \"Pclass\", \"Name\", \"Sex\", \"Title\", \"SimpTitle\")]\n\nm.weirdo_vec <- as.matrix(weirdos %>%\n  filter(Sex == \"male\") %>%\n  select(PassengerId))\n\ncombi[combi$PassengerId %in% m.weirdo_vec, \"SimpTitle\"] <- 'Mr'\n\ncombi$SimpTitle[combi$PassengerId %in% c('797')] <- 'Mrs'\n\ncombi[combi$Title == 'Dr',]\n\nggplot(combi, aes(SimpTitle)) +\n    geom_bar()\n\n\n\nweirdos$Survived<-as.factor(weirdos$Survived)\n\ncombi$Title <- factor(combi$Title)\ncombi$SimpTitle <- factor(combi$SimpTitle)","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"5f3f92035b009987284a48e32e604ac2e33fd8f4"},"cell_type":"code","source":"\n### Famili size feature\n\ncombi$FamilySize <- combi$SibSp + combi$Parch + 1\n\nggplot(combi[1:891,], aes(FamilySize, fill = Survived)) +\n    geom_bar(position = \"dodge\") +\n    scale_x_continuous(breaks = c(1:11)) +\n    labs(x = 'Family Size')\n\nboxplot(combi$FamilySize)\n##PARty size\nboxplot(combi$Fare)\nticket.party.size <- rep(0, nrow(combi))\navg.fare <- rep(0.0, nrow(combi))\ntickets <- unique(combi$Ticket)\n\n\n\nfor (i in 1:length(tickets)) {\n    current.ticket <- tickets[i]\n    party.indexes <- which(combi$Ticket == current.ticket)\n    current.avg.fare <- combi[party.indexes[1], \"Fare\"] / length(party.indexes)\n\n    for (k in 1:length(party.indexes)) {\n        ticket.party.size[party.indexes[k]] <- length(party.indexes)\n        avg.fare[party.indexes[k]] <- current.avg.fare\n    }\n}\n\ncombi$PartySize <- ticket.party.size\ncombi$AvgFare <- avg.fare\nggplot(combi[1:891,], aes(PartySize, fill = Survived)) +\n    geom_bar(position = \"dodge\") +\n    scale_x_continuous(breaks = c(1:11)) +\n    labs(x = 'Party Size')\n\nsummary(combi$AvgFare)\nboxplot(combi$AvgFare)\n\n\n\n\nggplot(combi, aes(y = AvgFare, x = Pclass)) + geom_boxplot(aes(fill = Survived)) + theme_bw()\n\nggplot(combi, aes(y = AvgFare, x = Fare)) +\n    geom_jitter(aes(color = Survived, shape = Pclass)) +\n    theme_bw() +\n    scale_shape(solid = F) +\n    geom_vline(xintercept = 3, color = 'darkred', lty = 2) +\n    geom_hline(yintercept = 3, color = 'red', lty = 2)\n\n\nbeanplot(AvgFare ~ Survived * Pclass, side = 'b', combi, col = list('yellow', 'orange'),\n         border = c('yellow2', 'darkorange'), ll = 0.05, boxwex = .5,\n         main = 'Passenger survival by pclass and Age', xlab = 'Passenger Class', ylab = 'Age')\nlegend('topright', fill = c('yellow', 'orange'), legend = c(\"Dead\", \"Survived\"), bty = 'n', cex = .8)\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"35beb9f6d627e1c47ed0c8530782a0ba0e76f385"},"cell_type":"code","source":"#FamilyID\ncombi$Surname <- sapply(combi$Name, FUN = function(x) { strsplit(x, split = '[,.]')[[1]][1] })\ncombi$FamilyID <- paste(as.character(combi$FamilySize), combi$Surname, sep = \"\")\n\n\ncombi$FamilyID[combi$FamilySize <= 2] <- 'Small'\n\n\ntable(combi$FamilyID)\n\n\n\n\n\n\nfamIDs <- data.frame(table(combi$FamilyID))\nfamIDs <- famIDs[famIDs$Freq <= 2,]\n\n##combi$FamilyID[combi$FamilyID %in% famIDs$Var1] <- 'Small'\ncombi$FamilyID <- factor(combi$FamilyID)\n\n\n\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"164ea4cb70302858b1ffe42e1883ca100d6e07c0"},"cell_type":"code","source":"\nggplot(combi, aes(x = SimpTitle, y = Age)) +\n    geom_jitter(color = 'blue', shape = 21, alpha = .7) +\n    stat_summary(aes(y = Age, group = 1), fun.y = median, colour = \"red\", geom = \"point\", group = 1) +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n    labs(caption = 'red points are median values')\n\n\nggplot(combi, aes(x = PartySize, y = Age)) +\n    geom_jitter(color = 'blue', shape = 21, alpha = .7) +\n    stat_summary(aes(y = Age, group = 1), fun.y = median, colour = \"red\", geom = \"point\", group = 1) +\n    theme_bw() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n    labs(caption = 'red points are median values')\n\nsummary(combi$Age)\nmedian(combi$Age, na.rm = T)\nboxplot(combi$Age)\ntop.qrt.age <- boxplot.stats(combi$Age)$stats[5]\nage.outlier.filter <- combi$Age < top.qrt.age\ncombi[age.outlier.filter,]\n\n\nAgefit <- rpart(Age ~ Pclass + Sex + SibSp + Parch + Fare + Embarked + SimpTitle + PartySize,\n                  data = combi[!is.na(combi$Age),],\n                  method = \"anova\")\n combi$Age[is.na(combi$Age)] <- predict(Agefit, combi[is.na(combi$Age),])","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"27a96af55f1ff2bb524bb195bda54c485f518749"},"cell_type":"code","source":"##Missing Emb\n\ncombi[combi$Embarked == \"\",]\n\nembark.na.rm <- combi[1:891,] %>%\n    filter(PassengerId != 62 & PassengerId != 830)\nggplot(embark.na.rm, aes(x = Embarked, y = Fare, fill = factor(Sex))) +\n    geom_boxplot() +\n    geom_hline(aes(yintercept = 80),\n             colour = 'red', linetype = 'dashed', lwd = 2)\n\n\n\n#which(combi$Embarked == '')\n\n combi$Embarked[c(62, 830)] = \"C\"\n combi$Embarked <- factor(combi$Embarked)\n\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"90ef992eee1d57f3bcfe5f4fc07b698360b5d539"},"cell_type":"code","source":"\n\n\n##Missing Fare\ntop.qrt.fare <- boxplot.stats(combi$Fare)$stats[5]\nfare.outlier.filter <- combi$Fare < top.qrt.fare\nnonoutlier.fares.data <- combi[fare.outlier.filter,]\n\nfare.equation = \"Fare ~ Pclass + Sex + Age + SibSp + Parch + Embarked\"\nFare.model <- lm(\n  formula = fare.equation,\n  data = nonoutlier.fares.data\n)\nFare.rows <- combi[is.na(combi$Fare), c(\"Pclass\", \"Sex\", \"Age\", \"SibSp\", \"Parch\", \"Embarked\")]\n\nFare.predictions <- predict(Fare.model, Fare.rows)\n\ncombi[is.na(combi$Fare), \"Fare\"] <- Fare.predictions\ntable(is.na(combi$Fare))\n\n## as factors\ncombi$Pclass <- factor(combi$Pclass)\ncombi$Title <- factor(combi$Title)","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"c1c271711f574dbf5a7cf50489fdc40c28004409"},"cell_type":"code","source":"train <- combi[1:891,]\ntest <- combi[892:1309,]\n\n\n","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"04bd502a8cda43f344fa841887dc6eb48a8e4064"},"cell_type":"code","source":"fit <- cforest(as.factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + Fare +\n                                       Embarked + SimpTitle +  FamilyID + PartySize ,\n                 data = train,\n                 controls = cforest_unbiased(ntree = 2000, mtry = 3))\n\nPrediction <- predict(fit, newdata = test, OOB = TRUE, type = \"response\")\nNROW(Prediction)\nsubmit <- data.frame(PassengerId = test$PassengerId, Survived = Prediction)\n\n\nsubmit_data <- function(D) {\n    if (!is.null(D$Survived)) {\n        D$Survived <- factor(D$Survived,\n        levels = c('Survived', 'Dead'),\n        labels = c(1, 0))\n    }\n   \n    D\n}\nsubmit<-submit_data(submit)\nwrite.csv(submit, file = \"ctree4.csv\", row.names = FALSE)","execution_count":null,"outputs":[]},{"metadata":{"trusted":true,"_uuid":"f3769ee1258c562c2170c8a11688ef0a0586aa13"},"cell_type":"code","source":"write_csv(submit, \"ctree4.csv\")","execution_count":null,"outputs":[]}],"metadata":{"kernelspec":{"display_name":"R","language":"R","name":"ir"},"language_info":{"mimetype":"text/x-r-source","name":"R","pygments_lexer":"r","version":"3.4.2","file_extension":".r","codemirror_mode":"r"}},"nbformat":4,"nbformat_minor":1}