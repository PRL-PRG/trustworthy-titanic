## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
testdata <- read.csv('../input/test.csv',header = TRUE, stringsAsFactors = FALSE, na.strings = c("", "NA"))
traindata <- read.csv('../input/train.csv',header = TRUE, stringsAsFactors = FALSE, na.strings = c("", "NA"))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(testdata)
str(traindata)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(testdata$Pclass)/nrow(testdata)
table(traindata$Pclass)/nrow(traindata)

table(testdata$Sex)/nrow(testdata)
table(traindata$Sex)/nrow(traindata)

table(testdata$Embarked)/nrow(testdata)
table(traindata$Embarked)/nrow(traindata)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(is.na(traindata$Embarked))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(traindata$Embarked== "")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
hist(testdata$Age)
hist(traindata$Age)

summary(testdata$Age)
summary(traindata$Age)

hist(testdata$SibSp)
hist(traindata$SibSp)

summary(testdata$SibSp)
summary(traindata$SibSp)

hist(testdata$Parch)
hist(traindata$Parch)

summary(testdata$Parch)
summary(traindata$Parch)

hist(testdata$Fare)
hist(traindata$Fare)

summary(testdata$Fare)
summary(traindata$Fare)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mosaicplot(table (traindata$Pclass, traindata$Survived))
mosaicplot(table (traindata$Sex, traindata$Survived))
mosaicplot(table (traindata$Age, traindata$Survived))
mosaicplot(table (traindata$SibSp, traindata$Survived))
mosaicplot(table (traindata$Parch, traindata$Survived))
mosaicplot(table (traindata$Fare, traindata$Survived))
mosaicplot(table (traindata$Embarked, traindata$Survived))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(ggplot2)

ggplot(traindata,aes(x=Age,group=Survived,fill=Survived))+
  geom_histogram(position="dodge",binwidth=15)+theme_bw()

ggplot(traindata,aes(x=SibSp,group=Survived,fill=Survived))+
  geom_histogram(position="dodge",binwidth=1)+theme_bw()

ggplot(traindata,aes(x=Parch,group=Survived,fill=Survived))+
  geom_histogram(position="dodge",binwidth=1)+theme_bw()

ggplot(traindata,aes(x=Fare,group=Survived,fill=Survived))+
  geom_histogram(position="dodge",binwidth=55)+theme_bw()



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(dplyr)
library(mice)

full <- bind_rows(traindata, testdata) 


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$Sex, full$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$Title[full$Title == 'Mlle']        <- 'Miss' 
full$Title[full$Title == 'Ms']          <- 'Miss'
full$Title[full$Title == 'Mme']         <- 'Mrs' 
full$Title[full$Title %in% rare_title]  <- 'Rare Title'


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$Sex, full$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$Pclass <-as.factor(full$Pclass)
full$Sex <-as.factor(full$Sex)
full$Embarked <-as.factor(full$Embarked)
full$Cabin <-as.factor(full$Cabin)
full$Title <-as.factor(full$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
sum(is.na(full$Age))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
pMiss <- function(x){sum(is.na(x))/length(x)*100}
apply(full,2,pMiss)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullpart<-full[-c(1, 2, 4, 9, 11)]
summary(fullpart)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullpart$Pclass <-as.factor(fullpart$Pclass)
fullpart$Sex <-as.factor(fullpart$Sex)
fullpart$Embarked <-as.factor(fullpart$Embarked)
fullpart$Title <-as.factor(fullpart$Title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullIm <- mice(fullpart,m=5,maxit=50,meth='rf',seed=500)
summary(fullIm)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullcomplete <- complete(fullIm,1)
summary(fullcomplete)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
hist(full$Age, freq=F, main='Age full', 
     col='green', ylim=c(0,0.04))
hist(fullcomplete$Age, freq=F, main='Age fullcomplete', 
     col='red', ylim=c(0,0.04))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullcomplete$Cabin <- full$Cabin
summary(fullcomplete)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullcomplete$Cabin <-  substr(fullcomplete$Cabin,1,1)
fullcomplete$Cabin[1:45]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullcomplete$Deck <- fullcomplete$Cabin
fullcomplete <- fullcomplete[-c(9)]
summary(fullcomplete)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fullcomplete$Deck <-as.factor(fullcomplete$Deck)

fullCompleteIm <- mice(fullcomplete,m=5,maxit=50,meth='rf',seed=500)
fullcompletefinal <- complete(fullCompleteIm,1)
fullcompletefinal[1:20,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
traindatafinal <- fullcompletefinal[1:891,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
traindatafinal$Survived <- traindata$Survived
summary(traindatafinal)
str(traindatafinal)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
traindatafinal$Survived <- as.factor(traindatafinal$Survived)
str(traindatafinal)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
testdatafinal <- fullcompletefinal[892:1309,]
testdatafinal$PassengerId <- testdata$PassengerId
#split the train data set into training and testing sub data sets
traindatafinaltr <- traindatafinal[1:624,]
traindatafinaltes <- traindatafinal[625:891,]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
set.seed(652)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(randomForest)
rf_model <- randomForest(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch +  Fare + Embarked + Title + Deck ,data = traindatafinaltr)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(rf_model, ylim=c(0,0.36))
legend('topright', colnames(rf_model$err.rate), col=1:3, fill=1:3)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf_model <- randomForest(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch +  Fare + Embarked + Title + Deck , ntree=450, data = traindatafinaltr)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train.res <- tuneRF(traindatafinaltr[,-10], traindatafinaltr[,10],ntree=450, stepFactor = 1.5)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
importance    <- importance(rf_model,type=2)
importance


varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[ ,'MeanDecreaseGini'],2))



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rankImportance <- varImportance %>%
  mutate(Rank = paste0(dense_rank(desc(Importance))))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(rankImportance, aes(x = reorder(Variables, Importance), 
                           y = Importance, fill = Importance)) +
  geom_bar(stat='identity') + 
  geom_text(aes(x = Variables, y = 0.2, label = Rank),
            hjust=0, vjust=0.55, size = 7, colour = 'green') +
  labs(x = 'Variables') +
  coord_flip() 


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
predictiont1 <- predict(rf_model, traindatafinaltes, type="prob")[,2]


library(pROC)
library(ROCR)
library(caret)

preds <- prediction(as.numeric(predictiont1), traindatafinaltes$Survived)
perf <- performance(preds,"tpr","fpr")
performance(preds,"auc")@y.values

plot(perf,col='red',lwd=3)
abline(a=0,b=1,lwd=2,lty=2,col="gray")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf_model2 <- randomForest(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch +  Fare + Embarked + Title + Deck , ntree=450, mtry=2, data = traindatafinaltr)
predictiont2 <- predict(rf_model2, traindatafinaltes, type="prob")[,2]
preds2 <- prediction(as.numeric(predictiont2), traindatafinaltes$Survived)
perf <- performance(preds2,"tpr","fpr")
performance(preds2,"auc")@y.values

plot(perf,col='red',lwd=3)
abline(a=0,b=1,lwd=2,lty=2,col="gray")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
predictiont2 <- predict(rf_model2, traindatafinaltes)
confusionMatrix(predictiont2, traindatafinaltes$Survived)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
prediction <- predict(rf_model2, testdatafinal)

