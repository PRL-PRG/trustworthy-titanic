## ----message=F,warning=F,error=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#Loading packages
library("tidyverse")
library("VIM")
library("mice")
library("randomForest")
library("gmodels")
library("lattice")
library("caret")
library("irr")
library("corrplot")
library("party")


## ----message=FALSE, warning=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train<-read.csv("../input/train.csv",stringsAsFactors = F,na.strings=c("","NA"," "))
test<-read.csv("../input/test.csv",stringsAsFactors = F,na.strings=c("","NA"," "))
Full<-bind_rows(train,test)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(Full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
round (100 * prop.table(table(train$Survived)),2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mosaicplot(table(Full$Pclass,Full$Survived),color = 2:3,main="Suvival vs Ticket class",xlab = "Pclass", ylab = "Survived")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Name[1]


## ----message=FALSE, warning=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full<-Full %>% separate(Name,into=c("name","surname"),sep=", ")%>% separate(surname,into=c("title","surname"),sep="\\. ")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(Full$Survived,Full$title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$title[Full$title %in% c("Capt","Col","Major","Dr","Rev","Don")]<-"Officer" 
Full$title[Full$title %in% c("Jonkheer","Sir","the Countess","Dona","Lady")]<-"Royalty" 
Full$title[Full$title %in% c("Mme","Mrs")] <- "Mrs" 
Full$title[Full$title %in% c("Mlle","Miss","Ms")] <- "Miss"


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(Full[1:891,],aes(x=title,fill=factor(Survived)))+geom_bar(position="dodge")+ggtitle("Survival Vs Title")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mosaicplot(table(Full$Sex,Full$Survived),color = 2:3,main="Survival Vs Gender")



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(train,aes(SibSp,Parch,color=factor(Survived)))+geom_count()+ggtitle("Survival as a function of Parent/Kids number and Spouse/Sibling number")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Fsize<-Full$SibSp+Full$Parch+1
ggplot(Full[1:891,],aes(x=Fsize,fill=factor(Survived)))+geom_bar(position="dodge")+ggtitle("Survival VS family size")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Ftype[Full$Fsize==1]<-"Solo"
Full$Ftype[Full$Fsize>4]<-"Large"
Full$Ftype[Full$Fsize>1&Full$Fsize<5]<-"Small"
mosaicplot(table(Full$Ftype,Full$Survived),color =2:3, main="Survival Vs Family size")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(Full$Fare)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full[is.na(Full$Fare),]


## ----warning=FALSE,error=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(Full[Full$Pclass==3&Full$Embarked=="S",],aes(Fare))+geom_density()+geom_vline(aes(xintercept=median(Fare,na.rm = T)),color="red",linetype="dashed",lwd=2)+ggtitle("Fare density for Pclass=3 and Embarked = S")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Fare[is.na(Full$Fare)]<-median(Full$Fare[Full$Pclass==3&Full$Embarked=="S"],na.rm=T)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
head(Full$Cabin)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
round((100*sum(is.na(Full$Cabin))/length(Full$Cabin)),2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Cabin[is.na(Full$Cabin)]<-"U"
Full$Cabin<-substr(Full$Cabin,1,1)
unique(Full$Cabin)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(Full[1:891,],aes(x=Cabin,fill=factor(Survived)))+geom_bar(position="dodge")


## ----warning=F-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(factor(Full$Embarked))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full %>% filter(is.na(Embarked))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(Full %>% filter(!is.na(Embarked)),aes(x=Embarked,y=Fare,fill=factor(Pclass)))+geom_boxplot()+geom_hline(aes(yintercept=80),color="purple",lwd=2,linetype="dashed")+ggtitle("Fare Vs Embarked port per Class")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$Embarked[is.na(Full$Embarked)]<-"C"


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(Full$Age)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(Full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
To_factor<-c("Survived","Pclass","title","Sex","Embarked","Cabin","Ftype")
Full[To_factor]<-lapply (Full[To_factor],function(x)as.factor(x))


## ----results='hide',message=FALSE------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mice_mod<-mice(Full[,!names(Full)%in%c("PassengerId","Survived","name","surname","Ticket")],seed=1991,m=20)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(mice_mod)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
densityplot(mice_mod)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
output<-complete(mice_mod)
Full$Age<-output$Age


## ----warning=F,error=F-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(Full[1:891,],aes(Age,fill=factor(Survived)))+geom_density(alpha=0.5)+ggtitle("Survival Vs Age")+geom_vline(aes(xintercept=15),color="red",linetype="dashed",lwd=2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full$child<-factor(ifelse(Full$Age<15,1,0))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(Full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Full[1:891,] %>% select(-PassengerId,-name,-surname,-Ticket) %>% mutate(
  Survived=as.numeric  (factor(Survived)),
  Ftype=as.numeric  (factor(Ftype)),
  Pclass=as.numeric (Pclass),
  title=as.numeric (title),
  Sex=as.numeric (Sex),
  child=as.numeric (child),
  Cabin=as.numeric (Cabin),
  Embarked=as.numeric (Embarked)) %>% cor(use="complete.obs") %>% corrplot(type="lower",diag=F)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(Full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
round(100*colSums(is.na(Full))/nrow(Full),2)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train<-Full[1:891,]
test<-Full[-(1:891),]


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
rf_model <- randomForest(Survived ~ title + Age + Pclass + Sex + Fare  + Cabin + Embarked +child + Fsize, data = train, ntree=2000)

rf_model


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
importance<-importance(rf_model)


variable<-data.frame(name=row.names(importance),val=importance[,"MeanDecreaseGini"])


ggplot(variable,aes(x=reorder(name,val),y=val,fill=val))+geom_bar(stat="identity")+coord_flip()+ggtitle("Variables importance")+xlab("Variable")+ylab("Importance")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Survived<-predict(rf_model,test)
Submit<-data.frame(PassengerID=test$PassengerId,Survived)
write.csv(Submit,file="prediction.csv",row.names =F)

