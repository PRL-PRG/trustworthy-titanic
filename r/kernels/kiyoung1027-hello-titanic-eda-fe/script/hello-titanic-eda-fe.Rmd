---
title: 'Hello, Titanic! [EDA, Feature Engineering]'
author: 'Rooney Song'
date: '`r Sys.Date()`'
output: 
  html_document:
    highlight: pygments
    theme: readable
    number_sections: true
    toc: true
    code_folding : hide
---

Reference:

[Tidy TitaRnic](https://www.kaggle.com/headsortails/tidy-titarnic)
by [Heads or Tails](https://www.kaggle.com/headsortails).

[Divide and Conquer [0.82296]](https://www.kaggle.com/pliptor/divide-and-conquer-0-82296)
by [Oscar Takeshita](https://www.kaggle.com/pliptor).

[Titanic WCG+XGBoost [0.84688]](https://www.kaggle.com/cdeotte/titanic-wcg-xgboost-0-84688)
by [Chris Deotte](https://www.kaggle.com/cdeotte)

Thanks for sharing your ideas!

---

# Overview

## Library

```{r message = F, warning = F}
## Data manipulation
library(readr) # Loading dataset faster than default function
library(dplyr) # Manipulating dataset more easily
library(tidyr) # Changing dataset's structure
library(stringr) # Manipulating string datatype

## Visualization
library(ggplot2) # Many kinds of plots such as barchart and histogram 
library(gridExtra) # Multiple plots in one page
library(ggcorrplot) # Corelation plot
library(ggridges) # Density plots in ggplot2
library(rpart.plot) # Nice plot for decision tree

## Machine learning
library(rpart) # Decision tree
library(caret) # Useful package for modeling
```

## Loading & Check dataset 

```{r message = F}
train <- read_csv('../input/train.csv')
test <- read_csv('../input/test.csv')

names(train) <- tolower(names(train)) # It is for avoiding confusion of coding.
names(test) <- tolower(names(test))

combine <- bind_rows(train, test)
str(combine)
```

Comments:

- There is only one difference between test and train dataset. That is whether *Survived* is NA or not. if we combine these two datasets, we can get more information about Titanic. For this reason, I made *combine*.

```{r message = F, fig.align = 'center'}
temp_train <- as.data.frame(sapply(train, function(x) sum(is.na(x))))
names(temp_train) <- 'freq'

p1 <- ggplot(temp_train, aes(rownames(temp_train), freq)) + 
  geom_bar(stat = 'identity') + 
  geom_label(aes(label = freq)) + 
  scale_y_continuous(limit = c(0, 700)) + 
  labs(x = 'Column Name', y = 'Num of NA', title = 'Train') + 
  theme_bw()

temp_test <- as.data.frame(sapply(test, function(x) sum(is.na(x))))
names(temp_test) <- 'freq'

p2 <- ggplot(temp_test, aes(rownames(temp_test), freq)) + 
  geom_bar(stat = 'identity') + 
  geom_label(aes(label = freq)) + 
  scale_y_continuous(limit = c(0, 700)) + 
  labs(x = 'Column Name', y = 'Num of NA', title = 'Test') + 
  theme_bw()

grid.arrange(p1, p2)
```

Comments:

- In train and test dataset, there are four columns including *NA*.

- *Embarked* and *Fare* can be treated through EDA and ML, but *Age* and *Cabin* are not easy to be done because of their size. If we use *Age* and *Cabin* for modling, we must decide whether to replace these *NA* or not.

## Adding features & Changing data type

```{r message = F}
combine <- combine %>% mutate(
  survived = as.factor(survived), 
  embarked = as.factor(embarked), 
  sex = as.factor(sex), 
  title = as.factor(str_extract(name, '[A-Z][a-z]*\\.')), 
  deck = if_else(is.na(cabin), 'U', str_sub(cabin, 1, 1)) # U: Unknown deck
)

temp <- combine %>% 
  group_by(ticket) %>% 
  summarise(ticket_freq = n())

combine <- left_join(combine, temp, by = 'ticket')

train <- combine %>% 
  filter(!is.na(survived))

test <- combine %>% 
  filter(!is.na(survived))
```

Comments:

- *Sex*, *Embarked* and *Survived* are not ordinal features. So, we should change these features to factor.

- *Title*: It is useful to guess *Age*. For example, if someone's surname is Master, it is likely that he is a boy. So, he is probably younger than 20.

- *Deck*: If you think the position of a cabin is an important feature, *Deck* can be helpful. Because there are so many kinds of value in  *Cabin*, it is certain that this feature will cause overfitting. In this case, instead of using *Cabin*, putting *Deck* into a model is appropriate.

- *Ticket_Freq*: There are some tickets used by more than one person. It means that those who share a ticket is not alone in Titanic. It may be an important feature to decide whether to survive or not.

## Distribution of variables

```{r message = F, warning = F, fig.width = 15, fig.height = 5, fig.align = 'center'}
plot_list <- list()

# Variable: survived
plot_list[[1]] <- ggplot(train, aes(survived, fill = survived)) + 
  geom_bar() + 
  labs(x = 'Survived', y = 'Count') + 
  guides(fill = F) + 
  theme_bw()

# Variable: pclass
plot_list[[2]] <- ggplot(train, aes(pclass, fill = as.factor(pclass))) + 
  geom_bar() + 
  labs(x = 'Pclass', y = 'Count', fill = 'Type') + 
  guides(fill = F) + 
  theme_bw()

# Variable: name
plot_list[[3]] <- train %>% 
  group_by(title) %>% 
  count() %>% 
  ggplot(aes(title, n, fill = title)) + 
  geom_bar(stat = 'identity') + 
  labs(x = 'Titles', y = 'Count') + 
  guides(fill = F) + 
  theme_bw() + 
  coord_flip()

# Variable: name
plot_list[[4]] <- ggplot(train, aes(title, fill = sex)) + 
  geom_bar(position = 'fill') + 
  labs(x = NULL, y = 'Ratio', fill = 'Sex') + 
  coord_flip() + 
  theme_bw()

grid.arrange(plot_list[[1]], plot_list[[2]], plot_list[[3]], plot_list[[4]], ncol = 4)

# Variable: sex
plot_list[[5]] <- ggplot(train, aes(sex, fill = sex)) + 
  labs(x = 'Sex', y = 'Count', fill = 'Sex') + 
  geom_bar() + 
  labs(x = 'Sex') + 
  guides(fill = F) + 
  theme_bw()

# Variable: age
plot_list[[6]] <- ggplot(train, aes(age)) + 
  geom_histogram() + 
  labs(x = 'Age', y = 'Count') + 
  theme_bw()

# Variables: sibsp
plot_list[[7]] <- ggplot(train, aes(sibsp, fill = as.factor(sibsp))) + 
  geom_bar() + 
  scale_y_continuous(limit = c(0, 700)) + 
  labs(x = 'SibSp', y = 'Count') + 
  guides(fill = F) + 
  theme_bw()

# Variables: parch
plot_list[[8]] <- ggplot(train, aes(parch, fill = as.factor(parch))) + 
  geom_bar() + 
  labs(x = 'ParCh', y = 'Count') + 
  scale_y_continuous(limit = c(0, 700)) + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(plot_list[[5]], plot_list[[6]], plot_list[[7]], plot_list[[8]], ncol = 4)

# Variable: ticket_freq
plot_list[[9]] <- ggplot(train, aes(ticket_freq, fill = as.factor(ticket_freq))) + 
  geom_bar() + 
  scale_x_continuous(breaks = 0:10) + 
  labs(x = 'Ticket_Freq', y = 'Count') + 
  guides(fill = F) + 
  theme_bw()

# Variable: fare
plot_list[[10]] <- ggplot(train, aes(fare)) + 
  geom_histogram() + 
  labs(x = 'Fare', y = 'Count') + 
  theme_bw()

# Variable: deck
plot_list[[11]] <- train %>% 
  group_by(deck) %>% 
  count() %>% 
  ggplot(aes(reorder(deck, -n, fun = max), n, fill = deck)) + 
  geom_bar(stat = 'identity') + 
  labs(x = 'Deck', y = 'Count') + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(plot_list[[9]], plot_list[[10]], plot_list[[11]], ncol = 3)
```

## Correlation between variables

```{r message = F, fig.align = 'center'}
train %>% 
  select(-passengerid, -name, -cabin, -ticket, -title, -deck, -embarked) %>%
  mutate(sex = if_else(sex == 'male', 1, 0)) %>% 
  mutate(sex = as.integer(sex),
         pclass = as.integer(pclass),
         survived = as.integer(survived)) %>%
  cor(use = 'complete.obs') %>% 
  ggcorrplot(type = 'lower', lab = T, outline.col = 'black')
```

Comments:

- There is a strong correlation between some variables. For example, the correlation coefficient between *Sex* and *Survived* is -0.54. It gives a good insight into the relation between variables.

- It is easy to misunderstand this plot. For example, in *Embarked*, it is meaningless to understand relations with other variables on the correlation coefficient. This is because *Embarked* is not ordinal feature and has more than two kinds of value.

- This helps to give directions roughly on which variables we focus.

# Relaion between variables

```{r message = F}
get.binCI <- function(x, n) {
  as.list(setNames(binom.test(x, n)$conf.int, c('lwr', 'upr')))}
```

Comments:

- *get.binCI* is the function for performing the binomial test to see if the ratio is statistically significant. For example, if the number of samples is small, no matter how the raio is, it is not meaningful. This is because it may have happened by accidently. In this case, we can check how reliable it is through *get.binCI*.

- By using this function, we can get lower and upper bound called confidence interval with a significance level of 95%.

## Survived vs Other variable

```{r message = F, warning = F, fig.width = 15, fig.height = 5, fig.align = 'center'}
# age vs survived
plot_list[[1]] <- ggplot(train, aes(age, fill = survived)) + 
  geom_density(alpha = 0.25) + 
  labs(x = 'Age', y = 'Density', fill = 'Surv') + 
  theme_bw()

# fare vs survived
plot_list[[2]] <- ggplot(train, aes(fare, fill = survived)) + 
  geom_density(alpha = 0.25) + 
  scale_x_log10() + 
  labs(x = 'Fare', y = 'Density', fill = 'Surv') + 
  theme_bw()

grid.arrange(plot_list[[1]], plot_list[[2]], ncol = 1)

# pclass vs survived
plot_list[[3]] <- train %>% 
  group_by(pclass, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(pclass, ratio, fill = as.factor(pclass))) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Pclass', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

# sex vs survived
plot_list[[4]] <- train %>% 
  group_by(sex, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(sex, ratio, fill = sex)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Sex', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

# sibsp vs survived
plot_list[[5]] <- train %>% 
  group_by(sibsp, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(sibsp, ratio, fill = as.factor(sibsp))) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'SibSp', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

# parch vs survived
plot_list[[6]] <- train %>% 
  group_by(parch, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(parch, ratio, fill = as.factor(parch))) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'ParCh', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(plot_list[[3]], plot_list[[4]], plot_list[[5]], plot_list[[6]], ncol = 4)

# ticket_freq vs survived
plot_list[[7]] <- train %>% 
  group_by(ticket_freq, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(ticket_freq, ratio, fill = as.factor(ticket_freq))) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Ticket_Freq', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

# deck vs survived
plot_list[[8]] <- train %>% 
  group_by(deck, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(deck, ratio, fill = deck)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Deck', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

# embarked vs survived
plot_list[[9]] <- train %>% 
  group_by(embarked, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(embarked, ratio, fill = embarked)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Embarked', y = 'Survial Rate') + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(plot_list[[7]], plot_list[[8]], plot_list[[9]], ncol = 3)

# title vs survived
train %>% 
  group_by(title, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(title, ratio, fill = title)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Title', y = 'Survival Rate') + 
  guides(fill = F) + 
  theme_bw()
```

Comments:

- Some of features such as *Age*, *Fare*, *Pclass* and *Sex* are noteworthy.

- In terms of statistics, most of ratio are unreliable because of their size. However, because the assumptions for binomial test are wrong, you don't need to follow this test. It is up to you!

## Survived vs Other variable vs Another variable

```{r message = F, warning = F, fig.width = 10, fig.height = 5, fig.align = 'center'}
# sibsp vs parch vs survived
p1 <- train %>% 
  ggplot(aes(survived, fill = survived)) + 
  geom_bar() + 
  labs(x = 'X-axis: SibSp, Y-axis: ParCh', y = 'Count', fill = 'Surv') + 
  theme_bw() + 
  facet_grid(parch ~ sibsp)

p2 <- train %>% 
  ggplot(aes('', fill = survived)) + 
  geom_bar(position = 'fill') + 
  scale_y_continuous(breaks = c(0, 0.5, 1)) + 
  labs(x = 'X-axis: SibSp, Y-axis: ParCh', y = 'Ratio', fill = 'Surv') + 
  theme_bw() + 
  facet_grid(parch ~ sibsp)

grid.arrange(p1, p2, ncol = 2)

# pclass vs fare vs survived
train %>% 
  filter(fare != 0) %>% 
  ggplot(aes(as.factor(pclass), fare)) + 
  geom_boxplot(aes(fill = survived)) + 
  scale_y_log10() + 
  labs(x = 'Pclass', y = 'Fare', fill = 'Surv') + 
  theme_bw()

# sex vs pclass vs survived
train %>% 
  group_by(sex, pclass, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(sex, ratio, fill = sex)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  facet_grid(~ pclass) + 
  labs(x = 'Sex, X-axis: Pclass', y = 'Survival Rate') + 
  guides(fill = F) + 
  theme_bw()

# deck vs pclass vs survived
train %>% 
  group_by(deck, pclass, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(deck, ratio, fill = deck)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Deck, Y-axis: Pclass', y = 'Survival Rate') + 
  facet_wrap(~ pclass, ncol = 1) + 
  guides(fill = F) + 
  theme_bw()

# age vs sex vs survived
train %>% 
  ggplot(aes(age, fill = survived)) + 
  geom_density(alpha = 0.5) + 
  labs(x = 'Age, Y-axis: Sex', y = 'Density', fill = 'Surv') + 
  facet_wrap(~ sex, ncol = 1) + 
  theme_bw()
```

Comments:

- *SibSp vs Parch vs Survived* gives an insight about feature engineering. This is because as you can see, the more than four *SibSp* and *ParCh* are, the more likely they will not survive. If we group it into one category, it can be a good candidate for predictor.

- *Pclass vs Fare vs Survived* shows that the more money passengers pay, the higher the survival rate. It means that it can be predictor. But, I think this is not good predictor because the difference of fare is not great.

- *Sex vs Pclass vs Survived* is especially impressive! In this plot, we can see that survival rate about the women on the 1st class is 0.968 and on the 2nd class is 0.921. On the other hand, the men in the 2nd class are 0.157 and the 3rd class is 0.135. Given that the average performance of the survival models in Kaggle is 0.8, these results can only be quite interesting and attractive!

- *Age vs Sex vs Survived* shows that especially in male, there is a big difference in the distribution of the dead to the living under the age of 13. It means that those who are younger and male are more likly to survive in Titanic.

```{r message = F, warning = F, fig.width = 12.5, fig.height = 5, fig.align = 'center'}
# age_group vs survived, sex == male
temp <- train %>% 
  filter(sex == 'male')

temp$age_group <- NA

for(i in 1:20) {
  if(i == 1) {
    temp$age_group[temp$age > 5*(i - 1) & temp$age <= 5*i] <- '01 ~ 05'
  } else if(i == 2) {
    temp$age_group[temp$age > 5*(i - 1) & temp$age <= 5*i] <- '06 ~ 10'
  }
  else{
    temp$age_group[temp$age > 5*(i - 1) & temp$age <= 5*i] <- paste0(5*(i - 1) + 1, ' ~ ', 5*i)
  }
}

temp_count <- temp %>% 
  group_by(age_group) %>% 
  summarise(count = n())

temp_ratio <- temp %>% 
  group_by(age_group, survived) %>% 
  summarise(count = n()) %>% 
  mutate(percent = round(count/sum(count)*100, 1))

ggplot(temp) + 
  geom_bar(aes(age_group, fill = survived)) + 
  geom_text(data = temp_count, aes(age_group, count, label = count), vjust = -0.25, fontface = 'bold') + 
  geom_label(data = temp_ratio, aes(age_group, count, label = paste0(percent, '%'), group = survived), 
             position = position_stack(vjust = 0.5)) + 
  labs(x = 'Age_group', y = 'Count', fill = 'Surv') + 
  theme_bw()
```

Comments: 

- This plot shows well that young boys under five are more likely to survive in Titanic.

# Creating derived variables

## *Family*: Size of family

```{r}
combine <- combine %>% 
  mutate(family = sibsp + parch + 1)
```

```{r, echo = F, message = F, warning = F, fig.width = 10, fig.height = 5, fig.align = 'center'}
p1 <- combine %>% 
  filter(!is.na(survived)) %>% 
  ggplot(aes(as.factor(family), fill = as.factor(family))) + 
  geom_bar() + 
  labs(x = 'Family', y = 'Count') + 
  guides(fill = F) + 
  theme_bw()

p2 <- combine %>% 
  filter(!is.na(survived)) %>% 
  group_by(family, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  replace(., is.na(.), 0) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(as.factor(family), ratio)) + 
  geom_bar(stat = 'identity', aes(fill = as.factor(family))) + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Family', y = 'Survival Rate') + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(p1, p2, ncol = 2)
```

Comments:

- *Family* == 1 means that not one of the passengers' families was on Titanic. 

- You can see that the survival rate is decreased with *Family* more than 5 except *Family* == 1.

## *Fare_eff*: Effective fare

```{r}
combine <- combine %>% 
  mutate(fare_eff = fare/ticket_freq)
```

Comments: 

- There are passengers who shared their ticket. it is unreasonable that they had same *Fare* values. If they used the same ticket, it would be reasonable to share the fare of the ticket equally.

```{r message = F, warning = F, fig.width = 10, fig.height = 5, fig.align = 'center'}
p1 <- combine %>% 
  filter(!is.na(survived), fare_eff != 0) %>% 
  ggplot(aes(fare, pclass, fill = as.factor(pclass))) + 
  geom_density_ridges() + 
  scale_x_log10() + 
  labs(x = 'Fare', y = 'Pclass') + 
  guides(fill = F) + 
  theme_bw()

p2 <- combine %>% 
  filter(!is.na(survived), fare_eff != 0) %>% 
  ggplot(aes(fare_eff, pclass, fill = as.factor(pclass))) + 
  geom_density_ridges() + 
  scale_x_log10() + 
  labs(x = 'Fare_eff', y = 'Pclass') + 
  guides(fill = F) + 
  theme_bw()

grid.arrange(p1, p2, ncol = 2)
```

Comments: 

- When X axis is changed to *Fare_eff*, you can see that the overlapping of the fares for each class is significantly reduced.

- When X axis is *Fare*, it is a bimodal form, which means that there are more than one variable involved in *Fare*. However, as a result of changing to *Fare_eff*, it is seen that the shape of bimodal disappears much. It can be interpreted that *Ticket_Freq* influenced to *Fare* as a variable.

```{r message = F, warning = F, fig.width = 16, fig.height = 5, fig.align = 'center'}
combine %>% 
  filter(!is.na(survived), fare_eff != 0) %>% 
  ggplot(aes(pclass, fare, fill = as.factor(pclass))) + 
  geom_boxplot() + 
  facet_wrap(~ ticket_freq, ncol = 9) + 
  scale_y_log10() + 
  labs(x = 'Fare_eff', y = 'Pclass') + 
  guides(fill = F) + 
  theme_bw()
```

Comments:

- As a result of analyzing by *Ticket_Freq*, it was confirmed that the difference of *Fare_eff* value is clearly displayed.

- Ironically, the more tickets they share, the higher the *Fare_eff* value. I guess this is the result of other variables not included in this dataset.

## *Fare_free*: Whether *Fare* is free

```{r message = F}
combine <- combine %>% 
  mutate(fare_free = if_else(fare == 0, T, F))
```

Comments: 

- There are some cases that passengers didn't pay the ticket.

```{r message = F}
combine %>% 
  filter(fare_free == T, !is.na(survived)) %>% 
  group_by(survived) %>% 
  summarise(count = n())

combine %>% 
  filter(fare_free == T) %>% 
  select(-c(survived, passengerid, name, cabin, title, fare_free, fare, sibsp, parch)) %>% 
  as.data.frame()
```

Comments: 

- *Fare_free* shows that those who didn't pay the ticket had a tendency to die. 14 out of 15 people died. I don't think this is a coincidence.

- There are some common points that these passenger's gender is male, and they embarked for Southampton and were alone on board. So, because of these common points, whether to use it as a feature for modeling or not must be considered. In my model for classifying survivor, I didn't use it because I thought other features would be able to sort out these passengers well without using it.

## *Age_known*: Whether *Age* is NA

```{r}
combine <- combine %>% 
  mutate(age_known = !is.na(age))
```

```{r fig.align = 'center'}
combine %>% 
  filter(!is.na(survived)) %>% 
  group_by(age_known, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(age_known, ratio)) + 
  geom_bar(stat = 'identity', aes(fill = age_known)) + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Age_known', y = 'Survival Rate') + 
  guides(fill = F) + 
  theme_bw()
```

## *Cabin_known*: Whether *Cabin* is NA

```{r}
combine <- combine %>% 
  mutate(cabin_known = !is.na(cabin))
```

```{r, echo = F, message = F, warning = F, fig.align = 'center'}
combine %>% 
  filter(!is.na(survived)) %>% 
  group_by(cabin_known, survived) %>% 
  summarise(count = n()) %>% 
  spread(survived, count) %>% 
  mutate(ratio = `1`/(`0` + `1`), 
         lwr = get.binCI(`1`, (`0` + `1`))[[1]], 
         upr = get.binCI(`1`, (`0` + `1`))[[2]]) %>% 
  ggplot(aes(cabin_known, ratio)) + 
  geom_bar(stat = 'identity', aes(fill = cabin_known)) + 
  geom_errorbar(aes(ymin = lwr, ymax = upr), size = 1, width = 0.5) + 
  labs(x = 'Cabin_known', y = 'Survival Rate') + 
  guides(fill = F) + 
  theme_bw()
```

Comments: 

- *Cabin_known* is a better candidate feature for modeling than *Age_known*. This is because its gap in survival rate between *Age_known == TRUE* and  *Age_known == FALSE* is obvious compared to *Age_known*.

```{r, echo = F}
train <- combine %>% # It's for adding new features to train dataset
  filter(!is.na(survived))

test <- combine %>% # It's for adding new features to test dataset
  filter(is.na(survived)) 
```

# Imputing missing values

Comments:

- In this kernel, I handle only *Embarked* and *Fare*, not *Age* and *Cabin*. Because if I replace NA with some values in *Age* and *Cabin*, I think it can cause to lower the accuracy of the dataset and performance of the model using *Age* or *Cabin* will be decreased. But, there are some kernels that make the good survival model using them. So, it is up to you to decide whether to do this or not.

## *Embarked* in train set

```{r}
train %>% 
  filter(is.na(embarked)) %>% 
  as.data.frame()
```

```{r fig.align = 'center'}
combine %>% 
  filter(!is.na(embarked), ticket_freq == 2, pclass == 1) %>% 
  ggplot(aes(fare)) + 
  geom_density() + 
  geom_vline(xintercept = 80, linetype='dashed', colour = 'red', size = 1) + 
  facet_grid(~ embarked) + 
  labs(x = 'Fare', y = 'Density') + 
  theme_bw()

train[is.na(train$embarked), 'embarked'] <- 'C'
```

Comments: 

- the passengers who have a missing value in *Embarked* paid 80 for their thickets. Based on this, I infered their missing values. 

- In terms of *Fare*, it is reasonable to replace *NA* values with *C* in *Embarked*.

## *Fare* in test dataset

```{r}
test %>% 
  filter(is.na(fare)) %>% 
  as.data.frame()
```

```{r message = F, warning = F, fig.align = 'center'}
tr_ctrl <- trainControl(method = 'repeatedcv', 
                        number = 10, 
                        repeats = 10)

model_dt <- train(fare ~ pclass + ticket_freq + embarked, 
                  data = combine %>% filter(!is.na(fare)), 
                  trControl = tr_ctrl, 
                  na.action = na.pass, 
                  method = 'rpart', tuneLength = 10)

temp <- predict(model_dt, test[which(is.na(test$fare)), c('pclass', 'ticket_freq', 'embarked')]) %>% round(2)
test[which(is.na(test$fare)), 'fare'] <- temp

rpart.plot(model_dt$finalModel)

model_dt$results
```

Comments: 

- By using decision tree, I replaced NA values with **`r temp`** in *Fare*

---

Thank you for reading my first kernel!

If you have any questions about this kernel, please leave a comment. :)