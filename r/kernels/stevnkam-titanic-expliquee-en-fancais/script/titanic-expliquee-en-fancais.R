## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library('ggplot2')  # pour la visualisation
library('ggthemes') # pour la visualisation
library('scales') # pour la visualisation
library('dplyr') # pour la manipulation
library('mice')  # pour la manipulation
library('prettyR')
library('randomForest') # l'algorithme de classifcation 
library('AUC')
library('Rcpp')
library('ROCR')
library('rpart')
#pour la prédiction des survivants



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train <- read.csv("../input/train.csv", header = TRUE, stringsAsFactors = F) 
train$IsTrain <- TRUE
test <- read.csv("../input/test.csv", header = TRUE, stringsAsFactors = F)
test$IsTrain <- FALSE
# L'instruction stringAsFactor=F permet de dire à R : ne transforme pas automatiquement tous 
#les champs String en Factor

# Dans un elan d'exploration de donneée nous allons fusionner les deux data train et test
test$Survived <- NA
full <- rbind(train, test)


# Regardons le contenu de full 

str(full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$title <- gsub('(.*,)|(\\..*)', '', full$Name)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 rare_title <- c( ' Capt', ' Col', ' Don', ' Dona', ' Dr', ' Jonkheer', ' Major', ' Rev', ' the Countess', ' Lady')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$title[full$title == ' Mlle'] <- 'Miss'
full$title[full$title == ' Ms'] <- 'Miss'
full$title[full$title == ' Mme'] <- 'Mrs'
full$title[full$title %in% rare_title] <- 'rare_title'
    


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$Sex, full$title)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$SurName <- sapply(full$Name, function(x) strsplit(x, split = '[,.]')[[1]][1])


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# definissons la taille des familles
full$Fsize <- full$SibSp + full$Parch + 1;

# Creons une variable pour identifier les familles

full$Family <- paste(full$SurName, full$Fsize, sep = '-')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(full[1:891,], aes(x=Fsize, fill= factor(Survived))) +
  geom_bar(stat = 'count', position = 'dodge') + scale_x_continuous(breaks = c(1:1)) +
  labs(x = 'family Size') +
  theme_few()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

full$FsizeD[full$Fsize == 1] <- 'singleton'
full$FsizeD[full$Fsize < 5 & full$Fsize >1] <- 'small'
full$FsizeD[full$Fsize > 4] <- 'large'



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
mosaicplot(table(full$FsizeD, full$Survived), main = 'Taille de la famille par la survie', shade = TRUE)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
colSums(is.na(full))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(full$Age)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
age_model <- rpart(Age ~ Pclass + Sex + SibSp + Parch + Fare + Embarked + title, 
                   
                   data = full[!is.na(full$Age), ], method = "anova")

full$Age[is.na(full$Age)] <- predict(age_model, full[is.na(full$Age),]) 

summary(full$Age)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(full$Fare)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(full[full$Pclass == '3' & full$Embarked == 'S', ], 
  aes(x = Fare)) +
  geom_density(fill = '#99d6ff', alpha=0.4) + 
  geom_vline(aes(xintercept=median(Fare, na.rm=T)),
    colour='red', linetype='dashed', lwd=1) +
  scale_x_continuous(labels=dollar_format()) +
  theme_few()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

full$Fare[1044] <- median(full[full$Pclass == '3' & full$Embarked == 'S', ]$Fare, na.rm = TRUE)

# full$Fare[1044]  a reçu comme valeur :

median(full[full$Pclass == '3' & full$Embarked == 'S', ]$Fare, na.rm = TRUE)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(full$Fare)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
fare.pclass.na <- full$Pclass[is.na(full$Fare)]
fare.median <- median(full$Fare[full$Pclass==fare.pclass.na], na.rm = TRUE)
full[is.na(full$Fare), "Fare"] <- fare.median
summary(full$Fare)



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
colSums(full == '')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# filtrons les valeurs manquantes et excluons les du data frame
embark_fake <- full %>%
  filter(PassengerId != 62 & PassengerId !=830)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
colSums(embark_fake == '')


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(embark_fake, aes(x=Embarked, y=Fare, fill = factor(Pclass))) +
  geom_boxplot() +
  geom_hline(aes(yintercept = 80) , 
colours = 'red' , linetype = 'dashed' , lwd = 2) + 
  scale_y_continuous(labels = dollar_format())  + 
  theme_few()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$Embarked)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full[full$Embarked == "", "Embarked"] <- "C"
full$Embarked[c(62, 830)] <- 'C'
table(full$Embarked)
full$Pclass[is.na(full$Pclass)] <- 'Adult'


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(full[1:891,], aes(Age, fill = factor(Survived))) +
  
  geom_histogram() + 
  
  facet_grid(.~Sex) +
  
  theme_few()



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$class[full$Age < 18] <- 'Child'
full$class[full$Age > 18] <- 'Adult'



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
table(full$class,full$Survived)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
full$class <- as.factor(full$class)
# Make variables factors into factors
full$class <- as.factor(full$class)

full$Sex <- as.factor(full$Sex)
full$title <- as.factor(full$title)
full$FsizeD <- as.factor(full$FsizeD)
full$Embarked <- as.factor(full$Embarked)

# Set a random seed
set.seed(129)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
md.pattern(full)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
train <- full[1:891,]
test <- full[892:1309,]
train <- train[, colSums(is.na(train)) == 0]
survived.eq <- "factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked + title + FsizeD"
survived.formula <- as.formula(survived.eq)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model <- randomForest(formula = survived.formula, data = train, ntree = 500, 
                              mtry = 3, 
                              nodesize = 0.01 * nrow(train))

model1 <- randomForest(formula = survived.formula, 
                               data = train, 
                               ntree = 500, 
                               mtry = 3, 
                               nodesize = 0.01 * nrow(test))

model2 <- randomForest(formula = survived.formula, 
                               data = train, 
                               ntree = 1000, 
                               mtry = 3,
                               nodesize = 0.01 * nrow(train))

model3 <- randomForest(formula = survived.formula, 
                               data = train, 
                               ntree = 1000, 
                               mtry = 3, 
                               nodesize = 0.01 * nrow(test))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
       par(mfrow=c(2,2),oma=c(0,0,2,0))
plot(model)
plot(model1)
plot(model2)
plot(model3)
title(main="le taux d'erreur OOB(hors sac) pour chaque modele ",outer=TRUE)
       


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      model$confusion


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model1$confusion


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model2$confusion


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model3$confusion


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
par(mfrow=c(2,2),oma=c(0,0,2,0))
varImpPlot(model)
varImpPlot(model1)
varImpPlot(model2)
varImpPlot(model3)
title(main="Importance by model",outer=TRUE)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
acc <- 1-model$err.rate[nrow(model$err.rate),1]
acc1 <- 1-model1$err.rate[nrow(model1$err.rate),1]
acc2 <- 1-model2$err.rate[nrow(model1$err.rate),1]
acc3 <- 1-model3$err.rate[nrow(model1$err.rate),1]
acc_all <- rbind(acc,acc1,acc2,acc3)
plot(acc_all, main="Accuracy by model", col=c(1,2,3,4), pch=16)
legend("bottomright", legend=c("model", "model1", "model2", "model3"), cex=0.7, col=c(1,2,3,4), pch=16)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
importance <- importance(model)
importance1 <- importance(model1)
importance2 <- importance(model2)
importance3 <- importance(model3)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[ ,'MeanDecreaseGini'],2))
# Create a rank variable based on importance
rankImportance <- varImportance %>%
  mutate(Rank = paste0('#',dense_rank(desc(Importance))))

# Use ggplot2 to visualize the relative importance of variables
ggplot(rankImportance, aes(x = reorder(Variables, Importance), 
    y = Importance, fill = Importance)) +
  geom_bar(stat='identity') + 
  geom_text(aes(x = Variables, y = 0.5, label = Rank),
    hjust=0, vjust=0.55, size = 4, colour = 'red') +
  labs(x = 'Variables') +
  coord_flip() + 
  theme_few()


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Predict
predict1 <- predict(model,type="prob",newdata=train)[,2]
predict2 <- predict(model1,type="prob",newdata=train)[,2]
predict3 <- predict(model2,type="prob",newdata=train)[,2]
predict4 <- predict(model3,type="prob",newdata=train)[,2]



## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Prediction
rf.pred <- prediction(predict1, train$Survived)
rf.pred1 <- prediction(predict2, train$Survived)
rf.pred2 <- prediction(predict3, train$Survived)
rf.pred3 <- prediction(predict4, train$Survived)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Performance
tt.rf.perf <- performance(rf.pred,"tpr","fpr")
tt.rf.perf1 <- performance(rf.pred1,"tpr","fpr")
tt.rf.perf2 <- performance(rf.pred2,"tpr","fpr")
tt.rf.perf3 <- performance(rf.pred3,"tpr","fpr")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Calculate AUC
rf.auc <- performance(rf.pred,"auc")
rf.auc1 <- performance(rf.pred1,"auc")
rf.auc2 <- performance(rf.pred2,"auc")
rf.auc3 <- performance(rf.pred3,"auc")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Converting S4 class to vector
tt.rf.auc <- unlist(slot(rf.auc, "y.values"))
tt.rf.auc1 <- unlist(slot(rf.auc1, "y.values"))
tt.rf.auc2 <- unlist(slot(rf.auc2, "y.values"))
tt.rf.auc3 <- unlist(slot(rf.auc3, "y.values"))
auc <- rbind(tt.rf.auc,tt.rf.auc1,tt.rf.auc2,tt.rf.auc3)
auc


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Minimum and Maximum AUC
minauc <- min(round(auc, digits = 4))
maxauc <- max(round(auc, digits = 4))
minauct <- paste(c("min(AUC) = "),minauc,sep="")
maxauct <- paste(c("max(AUC) = "),maxauc,sep="")


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(tt.rf.perf,main="ROC Curve for Random Forest",col=1,lwd=1) # Black
plot(tt.rf.perf1,col=2,lwd=1, add=TRUE) # Red
plot(tt.rf.perf2,col=3,lwd=1, add=TRUE) # Green
plot(tt.rf.perf3,col=4,lwd=1, add=TRUE) # Blue
abline(a=0,b=1,lwd=2,lty=2,col="gray")
legend('bottom',c(minauct,maxauct),cex=0.7, border = FALSE)
legend("bottomright", legend=c("model", "model1", "model2", "model3"), cex=0.7, col=c(1,2,3,4), lwd=1)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
titanic1.pred <- predict(model1, newdata = test)
titanic3.pred <- predict(model3, newdata = test)

PassengerId <- test$PassengerId

output1.df <- as.data.frame(PassengerId)
output3.df <- as.data.frame(PassengerId)

output1.df$Survived <- titanic1.pred
output3.df$Survived <- titanic3.pred

write.csv(output1.df, file="rf_model1.csv", row.names = FALSE)
write.csv(output3.df, file="rf_model3.csv", row.names = FALSE)

